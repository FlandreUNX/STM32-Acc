/*
 * DTW.c
 *
 *  Created on: 17 de jan de 2017
 *      Author: Alan
 */

#include "DTW.h"

int16_t letterO[300] = {124, 82, -5, -9, 126, 150, 30, -68, -134, -442, -328, -114, 43, 46, 82, 116, 138, 179, 265, 274, 267, 253, 243, 310, 314, 291, 238, 191, 218, 317, 373, 410, 364, 479, 372, 478, 554, 543, 364, 239, 319, 385, 454, 377, 403, 290, 228, 252, 216, 197, 115, 120, 201, 235, 191, 195, 137, 162, 197, 102, 42, 107, 120, 53, -129, -124, -102, -176, -264, -119, -113, -256, -300, -183, -61, -240, -427, -321, -302, -450, -443, -247, -324, -510, -511, -474, -477, -280, -195, -249, -230, -221, -206, -35, 198, 97, -230, 211, 356, 326, 997, 554, 32106, 28671, -30539, 17263, -28965, -27021, -28513, 20079, -13563, 13582, -12984, 4287, 28415, -26578, -8050, -27244, -25319, -26293, -13340, 18836, 18664, 10016, 1505, -22842, -19507, 2525, -2242, -19377, 26162, -24966, 11381, -26634, -32063, 15113, 14421, 27082, 9744, -7929, 27257, -17734, -18212, -1668, -20809, -10356, 27476, -11887, -28851, -11572, -8433, -21211, 7656, -28711, -27226, -14432, -21204, 30851, 24093, 22208, 15917, -11256, 9929, -10397, 18945, 12494, -3947, -16782, -17450, 29954, 7894, 2933, 32412, 21324, -20697, 29302, 16309, 6146, 21166, 776, -4621, -25507, 2704, 15083, 27513, 23021, 17555, -18629, 15875, 22135, 26841, 21463, 14965, -19043, 1253, 19959, -5549, -19769, -11707, -7907, 28016, 3230, 3080, 13436, 8165, -27267, 18667, -25775, 12932, -22128, 14212, -30963, -9050, -25643, -30886, -12662, 7724, 10214, 2333, -23216, 5325, 29138, 12529, -16636, -32446, 10371, 12932, -25209, -26727, -27900, -19466, -26460, 2505, 7483, 20625, 13589, -27329, 7733, 28946, -3062, -2735, 10220, 23630, -21435, -8353, -25354, 23533, -569, -21299, -11026, 8957, -13988, -3589, 9377, 3375, 31947, 5122, -27793, 17624, -15262, 21818, -28683, -17282, 6131, 27129, 22103, 22557, 13085, -19156, -263, -23221, -15068, 24826, -30946, 16397, -4512, -20270, -13675, -16420, -31131, 17608, -27388, 30665, -9506, 18556, 26685, -24389, 25078, 8492, 2048, 0, 0, 0, 0, 8492, 2048, 429, 2048, 8447, 2048};
//double letterO[300] = {91.799999999999983, 88.859999999999985, 60.701999999999984, 39.791399999999982, 65.65397999999999, 90.957785999999999, 72.670450200000005, 30.469315139999999, -18.871479401999999, -145.8100355814, -200.46702490697999, -174.52691743488597, -109.26884220442017, -62.688189543094111, -19.281732680165877, 21.302787123883881, 56.311950986718713, 93.118365690703087, 144.68285598349217, 183.47799918844453, 208.53459943191115, 221.8742196023378, 228.21195372163646, 252.74836760514552, 271.12385732360184, 277.08670012652129, 265.36069008856487, 243.05248306199542, 235.53673814339675, 259.97571670037769, 293.88300169026434, 328.71810118318501, 339.30267082822951, 381.21186957976062, 378.44830870583246, 408.31381609408277, 452.01967126585788, 479.31376988610054, 444.71963892027037, 383.00374724418924, 363.80262307093244, 370.16183614965269, 395.31328530475685, 389.81929971332977, 393.77350979933078, 362.6414568595315, 322.24901980167203, 301.17431386117039, 275.62201970281927, 252.03541379197347, 210.92478965438141, 183.64735275806697, 188.85314693064686, 202.6972028514528, 199.18804199601692, 197.93162939721182, 179.65214057804826, 174.35649840463378, 181.14954888324365, 157.40468421827055, 122.78327895278937, 118.04829526695255, 118.63380668686678, 98.943664680806734, 30.560565276564709, -15.807604306404702, -41.665323014483292, -81.965726110138291, -136.5760082770968, -131.30320579396775, -125.81224405577743, -164.8685708390442, -205.40799958733095, -198.68559971113166, -157.37991979779216, -182.16594385845451, -255.61616070091816, -275.23131249064272, -283.26191874344988, -333.28334312041488, -366.19834018429037, -330.43883812900322, -328.50718669030226, -382.95503068321159, -421.36852147824811, -437.15796503477367, -449.11057552434158, -398.37740286703911, -337.36418200692736, -310.85492740484915, -286.59844918339439, -266.91891442837607, -248.64324009986325, -184.55026806990426, -69.785187648932975, -19.749631354253079, -82.824741947977159, 5.3226806364159884, 110.52587644549119, 175.16811351184384, 421.71767945829066, 461.40237562080341, 9954.7816629345616, 15569.647164054193, 1737.0530148379348, 6394.8371103865538, -4213.1140227294127, -11055.479815910589, -16292.735871137411, -5381.2151097961878, -7835.750576857331, -1410.4254038001313, -4882.4977826600916, -2131.6484478620641, 7032.3460864965555, -3050.7577394524114, -4550.5304176166883, -11358.571292331682, -15546.699904632176, -18770.589933242522, -17141.412953269763, -6348.1890672888321, 1155.467652897818, 3813.627357028472, 3121.0391499199304, -4667.8725950560483, -9119.6108165392325, -5626.2275715774622, -4610.9593001042231, -9040.7715100729547, 1520.0599429489312, -6425.7580399357475, -1083.7306279550235, -8748.811439568517, -15743.068007697962, -6486.247605388573, -214.07332377200055, 7974.7486733595988, 8505.5240713517196, 3575.1668499462039, 10679.716794962342, 2155.6017564736385, -3954.6787704684525, -3268.6751393279169, -8530.7725975295416, -9078.3408182706789, 1887.9614272105246, -2244.527000952633, -10226.468900666841, -10630.128230466789, -9970.9897613267512, -13342.992832928725, -7043.2949830501075, -13543.606488135074, -17648.32454169455, -16683.427179186183, -18039.599025430329, -3372.4193178012301, 4867.2064775391391, 10069.444534277398, 11823.711173994177, 4899.7978217959244, 6408.5584752571467, 1366.8909326800026, 6640.3236528760017, 8396.4265570132011, 4693.3985899092404, -1749.2209870635315, -6459.4546909444725, 4464.5817163388683, 5493.4072014372068, 4725.2850410060446, 13031.299528704232, 15519.109670092963, 4654.2767690650735, 12048.593738345551, 13326.715616841884, 11172.500931789318, 14170.550652252521, 10152.185456576763, 5720.2298196037336, -3647.9391262773861, -1742.3573883941704, 3305.2498281240805, 10567.574879686856, 14303.602415780799, 15279.021691046559, 5106.6151837325915, 8337.1306286128129, 12476.491440028969, 16785.844008020278, 18188.990805614194, 17221.793563929936, 6342.3554947509547, 4815.5488463256679, 9358.5841924279666, 4886.3089346995766, -2510.2837457102964, -5269.2986219972072, -6060.6090353980453, 4162.3736752213681, 3882.6615726549576, 3641.8631008584703, 6580.1041706009291, 7055.5729194206497, -3241.1989564055448, 3331.2607305161182, -5400.617488638718, 99.167757952897773, -6568.9825694329711, -334.68779860308041, -9523.1814590221566, -9381.2270213155098, -14259.758914920856, -19247.6312404446, -17271.94186831122, -9773.1593078178521, -3777.0115154724963, -1944.0080608307471, -8325.6056425815223, -4230.4239498070656, 5780.1032351350541, 7804.7722645945378, 472.54058521617571, -9403.0215903486769, -3470.8151132440739, 1450.0294207291481, -6547.6794054895963, -12601.475583842715, -17191.0329086899, -17873.52303608293, -20449.466125258048, -13563.126287680632, -7249.2884013764415, 1112.9981190364915, 4855.7986833255436, -4799.6409216721186, -1039.8486451704825, 7955.9059483806614, 4650.5341638664622, 2434.8739147065235, 4770.4117402945667, 10428.288218206197, 869.30175274433714, -1897.3887730789643, -8934.3721411552742, 805.83950119130805, 393.38765083391564, -6114.3286444162586, -7587.8300510913814, -2624.3810357639663, -6033.4667250347757, -5300.1267075243422, -896.98869526703947, 384.60791331307246, 9853.3255393191503, 8433.9278775234052, -2434.1504857336167, 3583.2946599864681, -2070.2937380094718, 5096.1943833933692, -5037.5639316246416, -8710.8947521372484, -4258.3263264960733, 5157.8715714527489, 10241.410100016923, 13936.087070011845, 13680.76094900829, 3829.7326643058032, 2601.9128650140619, -5144.9609944901567, -8121.8726961431094, 1762.4891126998227, -8050.0576211101234, -715.94033477708672, -1854.7582343439606, -7379.330764040772, -9268.0315348285403, -11413.622074379979, -17328.835452065985, -6847.7848164461884, -13009.849371512331, 92.605439941367877, -2786.9761920410424, 3615.9166655712706, 10536.64166589989, 58.94916612992256, 7564.6644162909452, 7842.8650914036607, 6104.4055639825619, 4273.0838947877928, 2991.1587263514548, 2093.8111084460184, 1465.6677759122128, 3573.5674431385487, 3115.8972101969839, 2309.8280471378885, 2231.2796329965217, 4095.9957430975651, 3481.5970201682953};

//int16_t letterL[300] = {11, -11, -36, -10, 34, 52, 26, 0, -60, -36, 46, 27, 25, 22, 49, 32, -32, -78, -74, -17, 94, 108, 109, 19, -129, -65, -26, -79, 22, -65, -48, -55, 31, 102, 52, -3, 30, -1, -50, 1, 20, 108, -25, -79, 26, 124, 29, -67, -39, 65, 57, 21, -83, -67, -31, -63, -37, 19, 55, 83, 0, -91, -17, -144, -104, 13, 105, 34, 16, 31, 83, 152, 138, 121, 187, 195, 211, 187, 187, 176, 179, 100, 16, -19, -36, -27, -61, -114, -50, -9, -24, 34, 16, -11, -51, -134, -136, -121, -126, -109, 925, 413, 31850, 27647, -30507, 879, -24845, -28045, -10097, 20079, -5371, 13710, -12984, 5503, -20769, -26578, -5473, -27500, -25319, -26293, -13344, -13932, 18658, 26145, 1505, -23842, -3124, -30435, -2242, -19377, -14734, 7786, 11381, -26650, -27959, 2313, 14933, -5686, 9752, -23801, 27000, 16058, -22276, -1028, -21769, -10868, 28500, -28263, -12724, 21228, -8401, -21403, 7657, -29224, -32594, -14432, -21204, 30851, 24093, 4736, 9261, -11256, 9929, -10399, -13823, 12490, -3691, -18830, -25642, 29954, 5846, 2685, -372, 22348, -20697, 29284, 16305, -18430, 21422, 776, -4613, -25009, 3740, 14955, 27257, 23021, 1171, -2245, 15891, 21111, 26841, 21335, 14965, -19059, 9413, 19959, -5517, -19833, -11707, 24893, 28016, 3214, 19464, 31869, -25235, 5501, 26723, -30256, 14984, 2448, 12676, -6387, 23748, -25771, -30768, -8566, 7789, 9190, 2349, -23216, -20259, 12752, 12529, -16604, -16058, 11651, 15236, -25209, -27239, -19676, 13238, -10004, 2505, 5467, 20625, 13589, -25283, 1653, 29970, -3062, -3759, -23060, 23630, -21433, -14498, -25358, 21485, -5949, -21299, -11026, -23875, -9395, -3590, 9379, 3391, 31978, 5154, -23697, 21208, -15008, 5434, -30091, -25474, 1011, 31225, 22103, 22813, 13084, 13612, -1287, -31397, -15068, 25848, -29026, 16393, -6030, -23854, -15723, -18472, -31131, 25672, -27387, 30665, -1329, 18492, 26685, -24389, 16886, 8492, 2048, 0, 0, 0, 0, 8492, 2048, 429, 2048, 8447, 2048};
double letterL[300] = {7.9666666666666668, 2.2766666666666664, -9.2063333333333333, -9.4444333333333326, 3.5888966666666668, 18.112227666666666, 20.478559366666666, 14.334991556666665, -7.9655059103333343, -16.375854137233333, 2.3369021039366675, 9.7358314727556667, 14.315082030928966, 16.620557421650275, 26.334390195155191, 28.034073136608633, 10.023851195626042, -16.383304163061769, -33.668312914143236, -28.667819039900266, 8.1325266720698153, 38.092768670448869, 59.364938069314206, 47.255456648519946, -5.6211803460360343, -23.434826242225224, -24.204378369557656, -40.643064858690359, -21.850145401083246, -34.795101780758273, -38.75657124653079, -43.629599872571546, -21.240719910800081, 15.731496062439943, 26.612047243707959, 17.728433070595571, 21.409903149416898, 14.686932204591827, -4.7191474567857217, -3.0034032197500053, 3.8976177461749963, 35.128332422322494, 17.089832695625745, -11.737117113061979, -0.41598197914338453, 36.908812614599626, 34.536168830219736, 4.0753181811538148, -8.8472772731923293, 13.306905908765369, 26.414834136135756, 24.79038389529503, -7.5467312732934779, -25.382711891305433, -27.067898323913802, -37.847528826739662, -37.593270178717759, -20.615289125102432, 2.0692976124282989, 26.348508328699808, 18.443955830089863, -14.389230918937098, -15.172461643255968, -53.820723150279171, -68.874506205195416, -44.312154343636792, 0.4814919594542495, 10.537044371617974, 12.17593106013258, 17.823151742092804, 37.376206219464962, 71.76334435362547, 91.634341047537816, 100.44403873327647, 126.41082711329352, 146.98757897930545, 166.19130528551381, 172.43391369985966, 176.80373958990177, 176.56261771293123, 177.29383239905184, 154.10568267933627, 112.67397787553539, 73.171784512874765, 40.420249159012336, 20.19417441130863, -4.1640779120839611, -37.114854538458772, -40.980398176921142, -31.386278723844796, -29.170395106691355, -10.219276574683949, -2.353493602278764, -4.9474455215951343, -18.763211865116592, -53.33424830558161, -78.133973813907119, -90.993781669734972, -101.49564716881447, -103.74695301817013, 204.87713288728091, 267.31399302109662, 9742.1197951147678, 15113.583856580339, 1427.408699606236, 1262.8860897243651, -6569.4797371929444, -13012.135816035061, -12137.595071224543, -2472.61654985718, -3342.1315849000257, 1773.507890569982, -2653.7444766010126, -206.72113362070877, -6375.4047935344961, -12436.183355474146, -10347.228348831901, -15493.059844182331, -18440.84189092763, -20796.489323649337, -18560.742526554535, -17172.119768588174, -6423.083838011722, 3347.3413133917948, 2794.6389193742561, -5196.3527564380202, -4574.6469295066136, -12332.75285065463, -9305.52699545824, -12326.968896820767, -13049.078227774535, -6798.5547594421751, -1344.6883316095223, -8936.2818321266659, -14643.097282488665, -9556.2680977420659, -2209.487668419446, -3252.4413678936121, 648.89104247447176, -6686.0762702678703, 3419.7466108124909, 7211.2226275687426, -1634.9441607018807, -1452.8609124913164, -7547.7026387439209, -8543.7918471207449, 2569.3457070154791, -6680.3580050891642, -8493.4506035624145, 422.98457750630951, -2224.2107957455833, -7977.847557021908, -3287.3932899153356, -11068.375302940734, -17526.062712058512, -16597.843898440959, -17979.69072890867, -3330.4835102360685, 4896.5615428347519, 4848.3930799843265, 6172.1751559890281, 943.72260919231985, 3639.3058264346237, -572.18592149576352, -4547.4301450470339, 563.79889846707647, -712.64077107304638, -6147.8485397511322, -11996.093977825793, 588.93421552194377, 2166.0539508653605, 2321.7377656057524, 1513.6164359240267, 7763.9315051468184, -774.34794639722713, 8243.1564375219405, 10661.709506265357, 1934.1966543857498, 7780.537658070024, 5679.1763606490167, 2591.5234524543112, -5688.6335832819823, -2860.0435082973872, 2484.4695441918293, 9916.2286809342804, 13847.660076653996, 10044.662053657796, 6357.7634375604566, 9217.7344062923185, 12785.714084404623, 17002.299859083236, 18302.109901358264, 17300.976930950783, 6392.9838516655482, 7298.9886961658831, 11096.992087316117, 6112.7944611212824, -1670.9438772151025, -4681.7607140505716, 4190.6675001645999, 11338.267250115219, 8900.9870750806531, 12069.890952556456, 18009.623666789517, 5036.236566752661, 5175.6655967268625, 11639.865917708803, -928.89385760383811, 3844.974299677313, 3425.8820097741191, 6200.9174068418833, 2424.5421847893181, 8821.5795293525225, -1556.1943294532339, -10319.736030617263, -9793.6152214320828, -4518.8306550024581, -406.1814585017205, 420.37297904879563, -6670.5389146658435, -10747.07724026609, -3697.3540681862619, 1170.5521522696167, -4161.8134934112677, -7730.6694453878863, -1916.1686117715203, 3229.4819717599357, -5302.0626197680449, -11883.143833837632, -14221.000683686343, -5983.3004785804405, -7189.5103350063082, -4281.1572345044151, -1356.7100641530906, 5237.8029550928368, 7743.162068564985, -2164.6865520045103, -1019.3805864031571, 8277.4335895177901, 4875.603512662452, 2285.2224588637164, -5318.3442787953991, 3366.1590048432208, -4073.5886966097451, -7200.9120876268207, -12648.038461338774, -2408.126922937141, -3470.3888460559983, -8818.9721922391982, -9481.080534567438, -13799.256374197206, -12477.979461938045, -9811.5856233566301, -4054.4099363496407, -1820.7869554447482, 8318.8491311886755, 7369.394391832072, -1950.523925717549, 4997.0332519977155, -1004.4767236015991, 927.06629347888065, -8378.3535945647836, -13507.047516195347, -9151.6332613367431, 2961.35671706428, 8703.8497019449951, 12936.594791361495, 12980.816353953047, 13170.171447767132, 8833.0200134369916, -3235.9859905941066, -6785.5901934158737, 3004.486864608888, -6604.6591947737779, 294.63856365835545, -1602.7530054391511, -8278.1271038074046, -10511.588972665182, -12899.712280865628, -18369.098596605938, -5156.7690176241567, -11825.838312336909, 921.41318136416339, 246.28922695491434, 5720.0024588684391, 12009.501721207907, 1089.9512048455354, 5828.765843391875, 6627.736090374312, 5253.8152632620177, 3677.6706842834119, 2574.3694789983883, 1802.0586352988716, 1261.44104470921, 3430.6087312964469, 3015.8261119075128, 2239.7782783352586, 2182.2447948346808, 4061.6713563842764, 3457.5699494689934};

void printArray(double *array, int size) {
    int i;
    for (i = 0; i < size; i++) {
        printf("%lf, ", array[i]);
    }
}

void printMatrix(double *matrix, int rows, int columns) {
    int i, j;
    for (i = 0; i < rows; i++) {
        for (j = 0; j < columns; j++) {
            printf("%.2lf ", *(matrix + (i * columns) + j));
        }
        printf("\n");
    }
}

double average(int16_t *array, int begin, int end) {
    double sum = 0.0;
    int i;
    for(i = begin; i < end; i++) {
        sum += array[i];
    }
    return sum / (double) end - begin;
}

double min(double a, double b, double c) {
    if(a < b) {
        return a < c ? a : c;
    }
    return b < c ? b : c;
}

void ewma(int16_t *array, int size, double *result) {

    int s = size < 6 ? size : 6;
    double forecasted = average(array, 0, s);
    double smoothed = 0.0;

    int i;

    for (i = 1; i <= size; i++) {
        smoothed = EWMA_ALPHA * array[i - 1] + (1.0 - EWMA_ALPHA) * forecasted;
        forecasted = smoothed;
        result[i - 1] = smoothed;
    }

}

double dtwDistance(double *x, int sizeX, double *y, int sizeY) {

    int sX = sizeX / 3;
    int sY = sizeY / 3;
    int k, l;

    double acc[sY][sX];
    double dist;

    acc[0][0] = pow(x[0] - y[0], 2.0) + pow(x[1] - y[1], 2.0) + pow(x[2] - y[2], 2.0);;

    // Accumulated distance - Row 0
    for (int i = 1; i < sX; i++) {
        k = i * 3;
        dist = pow(x[k] - y[0], 2.0) + pow(x[k + 1] - y[1], 2.0) + pow(x[k + 2] - y[2], 2.0);
        acc[0][i] = acc[0][i - 1] + dist;
    }

    // Accumulated distance - Row 0
    for (int i = 1; i < sY; i++) {
        k = i * 3;
        dist = pow(x[0] - y[k], 2.0) + pow(x[1] - y[k + 1], 2.0) + pow(x[2] - y[k + 2], 2.0);
        acc[i][0] = acc[i - 1][0] + dist;
    }

    // Accumlated distance - Remaining
    double m;
    for (int i = 1; i < sY; i++) {
        k = i * 3;
        for (int j = 1; j < sX; j++) {
            l = j * 3;
            dist = pow(x[l] - y[k], 2.0) + pow(x[l + 1] - y[k + 1], 2.0) + pow(x[l + 2] - y[k + 2], 2.0);
            m = min(acc[i - 1][j - 1],
                    acc[i - 1][j],
                    acc[i][j - 1]);
            acc[i][j] = m + dist;
        }
    }

    return sqrt(acc[sY - 1][sX - 1]);

}

int knn(double *input, int size) {
//    double distanceO = dtwDistance(letterO, 300, input, 300);
//    double distanceL = dtwDistance(letterL, 300, input, 300);
//    return distanceO < distanceL ? 0 : 1;
	return 0;
}
