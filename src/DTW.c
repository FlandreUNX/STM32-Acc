/*
 * DTW.c
 *
 *  Created on: 17 de jan de 2017
 *      Author: Alan
 */

#include "DTW.h"

// Door Open
//float doorOpenX[29] = {-2.74866652, -2.82106662, -2.96774673, -3.2474227, -3.49119592, -3.65883708, -3.914186, -4.26393032, -4.62275124, -4.70592594, -4.48814821, -4.1377039, -4.10839272, -4.06987476, -4.05191231, -3.81433868, -3.40203714, -3.06842589, -2.88889813, -2.57122874, -2.18086004, -1.83560205, -1.51292145, -0.897045016, -0.471931517, -0.0903520584, 0.329753548, 0.68382746, 0.775679231};
//float doorOpenY[29] = {-1.98033345, -2.10623336, -2.02636337, -1.95845437, -2.02191806, -1.95534265, -2.01373982, -2.08761787, -2.16033244, -2.17823267, -2.00476289, -1.69733405, -1.49713385, -1.50699365, -1.3218956, -0.994326949, -0.600028872, -0.27902022, 0.0386858359, 0.207080096, 0.501956105, 0.798369288, 1.04485846, 1.21440089, 1.26108062, 1.30575645, 1.38502955, 1.28152072, 1.08006454};
//float doorOpenZ[29] = {10.1113329, 10.0389328, 9.90425301, 9.83397675, 9.90178394, 9.8712492, 9.82887459, 9.70021248, 9.59214878, 9.67850399, 9.687953, 9.44856739, 9.50899696, 9.49729824, 9.59110928, 9.76477623, 9.94334316, 10.0353403, 10.0517387, 10.0212173, 10.0448523, 10.2713966, 10.4389772, 10.3972845, 10.4280987, 10.6026688, 10.6258678, 10.5821075, 10.6504755};
//
//// Door Close
//float doorCloseX[43] = {0.624833345, 0.455383331, 0.387768328, 0.463437825, 0.5794065, 1.16758454, 2.14330912, 2.95231652, 3.50962162, 3.82173514, 4.03721476, 4.02005053, 3.58503532, 2.85452461, 2.3761673, 2.09831715, 1.63082206, 0.895575464, -0.0570971668, -0.921968043, -1.34137762, -1.82696438, -2.523875, -3.14371252, -3.47259879, -3.66381931, -4.09767342, -4.68037128, -5.23225975, -5.48058176, -5.29740715, -5.1661849, -5.29932928, -5.37753057, -5.20727158, -5.01609039, -5.01726341, -4.98808432, -4.77865887, -4.30206108, -3.79144263, -3.58100986, -3.48470688};
//float doorCloseY[43] = {-1.82716668, -2.02301669, -2.05811167, -2.00767827, -1.96937478, -1.36356235, -0.660493612, -0.0813455358, 0.210058123, 0.420040697, 0.55802846, 0.615619898, 0.622933924, 0.583053768, 0.591137648, 0.836796343, 1.14675748, 1.16273022, 0.861911178, 0.69933784, 0.768536508, 0.735975564, 0.368182898, -0.075271979, -0.394690394, -0.37228328, -0.332598299, -0.784818828, -0.942373157, -1.13966119, -1.20876288, -1.27513397, -1.53759384, -1.7663157, -1.91442096, -1.83209467, -1.92746627, -2.01822639, -2.00375843, -1.76563096, -1.62294161, -1.6040591, -1.57884133};
//float doorCloseZ[43] = {10.0303335, 10.0092335, 9.97646332, 9.92952442, 10.0166674, 10.1946669, 10.3612671, 10.5588875, 10.7752209, 10.6506548, 10.3324585, 10.2807207, 10.4755049, 10.5248537, 10.3013973, 10.3909779, 10.4206848, 10.1534796, 9.72943592, 9.7746048, 10.0702238, 10.0611563, 10.0458097, 10.2120667, 9.84544659, 9.54081249, 9.69656849, 9.6405983, 9.39741898, 9.53019333, 9.71013546, 9.87209511, 10.1504669, 10.1953268, 9.97772884, 9.75041008, 9.63928699, 9.489501, 9.46865082, 9.52005577, 9.74503899, 10.0075274, 10.1792688};
//
//// Light Up
//float lightUpX[27] = {-1.15983343, -0.976883411, -0.944818377, -1.14437282, -1.42806101, -1.74964273, -1.87574995, -1.83802497, -1.6796174, -1.58373213, -1.58261251, -1.50082874, -1.35358012, -1.20850611, -1.09495425, -0.895467997, -0.719827592, -0.569879293, -0.500915527, -0.39564088, -0.12694861, 0.0791359767, 0.175395191, 0.197776631, 0.165443644, 0.0528105535, -0.0500326082};
//float lightUpY[27] = {-0.842666626, -0.877866626, -0.881506622, -0.929054618, -1.00433826, -1.08103681, -1.06872571, -1.02710795, -0.89597553, -0.840182841, -0.885128021, -1.05458963, -1.10421276, -1.11494899, -1.14346433, -1.19342506, -1.27039754, -1.50127828, -1.72889483, -1.85222638, -2.13655853, -2.32359099, -2.53551364, -2.81585956, -3.10810161, -3.45367122, -3.86056972};
//float lightUpZ[27] = {11.7701664, 11.2601166, 11.5420818, 12.2164574, 13.0605202, 13.7743645, 14.2590551, 14.2533388, 14.015337, 13.8007355, 13.5455151, 13.1148605, 12.7384024, 12.5678816, 12.3555174, 11.8558617, 11.335103, 10.8145723, 10.3032007, 9.7412405, 8.93986797, 7.98890734, 7.21823502, 6.5107646, 6.00053501, 5.70937443, 5.41856194};
//
//// Light Down
//float lightDownX[39] = {-0.154500008, -0.219150007, -0.234405011, -0.248083502, -0.209658444, -0.167760909, -0.105432637, -0.139802843, -0.154861987, -0.0934033915, -0.0383823738, -0.0838676617, -0.160707369, -0.187495157, -0.176246613, -0.066372633, -0.0074608447, 0.00977740902, -0.0621558167, -0.0435090736, -0.0484563522, -0.0939194486, -0.0777436122, 0.185579479, 0.411905646, 0.366333961, 0.250433773, 0.370303631, 0.640212536, 0.673148751, 0.723204136, 0.713242888, 0.685270011, 0.659689009, 0.785782337, 0.817047656, 0.838933349, 0.914253354, 0.879977345};
//float lightDownY[39] = {-7.41149998, -7.58804989, -7.55863476, -7.50504446, -7.37453127, -7.18117189, -7.00082016, -6.88057423, -6.63740206, -6.37718153, -6.23102713, -6.1017189, -5.99620342, -5.80234241, -5.60963964, -5.38474798, -5.30232382, -5.1726265, -5.12083864, -5.05458689, -4.93321085, -4.84524775, -4.73867321, -4.56807137, -4.36765003, -4.28735495, -4.17714834, -3.89000392, -3.54800272, -3.37460184, -3.24122143, -3.06685495, -2.95079851, -2.83655882, -2.62159109, -2.53711367, -2.46597958, -2.41918564, -2.39242983};
//float lightDownZ[39] = {-5.6826663, -5.77186632, -5.88230658, -5.76761436, -5.54933023, -5.34553099, -5.22387171, -5.08471012, -4.98729706, -4.87110806, -4.8167758, -4.77574301, -4.86702013, -5.01791382, -5.18953991, -5.23767805, -5.57137442, -6.07496214, -6.61347342, -7.08943129, -7.4856019, -7.91892147, -8.14724541, -8.34307194, -8.70815086, -9.38370514, -9.69759369, -9.66531563, -9.80772114, -9.97640514, -10.1184835, -10.2149382, -10.267457, -10.4032202, -10.5402536, -10.7561779, -10.8443241, -11.0860271, -11.4982185};

float doorOpenX[35] = {8.30749989, 8.3352499, 8.35167503, 8.29717255, 8.04602051, 7.56121445, 6.89785004, 6.31349516, 5.70644665, 5.56651258, 5.56755877, 5.09729099, 4.54610348, 4.83827257, 4.9767909, 4.22775364, 2.99842763, 3.29289937, 3.64002943, 3.47202063, 2.8684144, 3.02789021, 3.36152315, 3.10306621, 2.52914643, 2.24140263, 2.12098193, 2.00368738, 1.80158114, 1.48910677, 1.06337476, 0.927362323, 1.20115364, 1.29680753, 1.06076527};
float doorOpenY[35] = {-1.08783329, -1.25948334, -1.18463838, -1.09324682, -0.954272747, -0.871990919, -0.769393623, -0.481575549, -0.0551028848, 0.303427964, 0.707399547, 0.852179706, 0.884525776, 0.874168038, 0.875917614, 0.76914233, 0.871399641, 1.24597967, 1.19618583, 0.834330082, 0.734031081, 1.34782171, 1.28547525, 0.662832677, 0.30198288, 0.175388023, -0.0242283866, -0.313959867, -0.648771882, -0.856140316, -1.07629824, -1.13140881, -1.10698617, -1.23089027, -1.56062317};
float doorOpenZ[35] = {5.64699984, 5.71089983, 5.61162996, 5.61414099, 5.78389883, 6.21472931, 7.09231043, 8.099617, 8.71773148, 8.84441185, 8.89408875, 9.6368618, 10.0968037, 9.73776245, 9.2584343, 9.66090393, 11.6586323, 12.1360426, 10.9882298, 9.68076134, 10.0825329, 10.9547729, 11.1843414, 10.2620392, 10.030427, 10.6512985, 11.1099091, 10.8189363, 10.2432556, 10.2002792, 10.6261959, 11.1043377, 10.950036, 10.6530256, 10.7481184};

float doorCloseX[35] = {1.35099995, 1.26370001, 1.54759002, 2.10631299, 2.53341913, 2.10939336, 1.79457533, 2.18320274, 2.81524181, 3.00566936, 2.75496864, 2.65747809, 2.76923466, 2.79946423, 2.57162499, 2.14513755, 2.05359626, 2.32551742, 2.83986211, 3.31990337, 4.03993225, 4.81995249, 5.42596674, 6.10817671, 6.84372377, 7.46360683, 7.56452465, 7.26616716, 6.77831697, 6.71282196, 7.46797514, 8.30858231, 8.70200729, 8.80640507, 8.90348339};
float doorCloseY[35] = {0.714333296, 0.665033281, 1.0355233, 1.41786623, 1.60750639, 1.40125453, 1.27187824, 1.42731476, 1.84512031, 1.92458415, 2.0372088, 2.12504625, 2.11753225, 2.25927258, 2.23249078, 1.9287436, 1.77312052, 1.66418433, 1.69592905, 1.97315025, 2.17020512, 2.12814355, 1.85270047, 1.69589031, 1.68812323, 1.5956862, 1.42298031, 1.50308621, 1.48716033, 1.47001219, 1.42200851, 1.48440599, 1.45308423, 1.29015899, 1.11311126};
float doorCloseZ[35] = {11.0828342, 10.9469843, 11.2628889, 11.4120226, 11.6874161, 11.9281912, 11.8717337, 11.3882141, 10.62675, 10.708725, 11.3361073, 11.3222752, 10.2625923, 9.86581421, 10.4280701, 10.7526493, 10.5628548, 10.0249987, 9.66349888, 10.2294493, 11.0756149, 10.8909302, 9.8196516, 8.44575596, 7.40602922, 7.05322027, 7.17525434, 8.10667801, 8.85167503, 8.46717262, 7.22002077, 6.32301474, 6.0281105, 6.09767723, 5.81337404};

float lightUpX[36] = {-0.0345000029, -0.114150003, -0.208905011, -0.200233504, -0.155163452, -0.123614416, 0.111469917, 0.444028944, 0.805820227, 1.32907414, 1.74035192, 1.67424631, 1.53497243, 1.15548074, 0.964836538, 0.900385559, 0.999269903, 1.04148889, 1.10104227, 1.04972959, 0.878810704, 0.687167466, 0.571017206, 0.399712056, 0.219798431, 0.141858906, 0.0723012313, -0.108389132, -0.207872391, -0.115510672, 0.0751425251, 0.184599772, 0.360219836, 0.354153872, 0.4399077, 0.391935378};
float lightUpY[36] = {-0.736833334, -0.740783334, -0.806548357, -0.813583851, -0.707508683, -0.50425607, -0.328979254, -0.233285472, -0.154299825, -0.0420098789, -0.227406919, -0.720184863, -1.10712945, -1.49199069, -1.96539342, -2.31477547, -2.71234274, -3.29063988, -3.78244781, -4.38171339, -5.06519938, -5.67563963, -6.17194748, -6.7233634, -7.25035429, -7.61624813, -7.98937368, -8.34956169, -8.66769314, -8.89038467, -9.01926899, -9.14248848, -9.27374172, -9.45861912, -9.53103352, -9.56372356};
float lightUpZ[36] = {11.8291674, 11.5564175, 11.5934925, 11.6494446, 12.4416113, 13.6831284, 14.7471895, 15.1020327, 15.2334232, 15.2713957, 14.8359766, 14.165184, 13.3356285, 12.54494, 11.7904577, 10.78232, 9.59962368, 8.04573631, 6.43001556, 4.65101099, 3.10570765, 2.30599546, 2.04919672, 1.56043768, 0.699306369, 0.00951445103, -0.449339867, -0.686537921, -0.864576519, -1.07320356, -1.00324249, -0.732269764, -0.548588812, -0.234012172, -0.0258085169, 0.347934037};

float lightDownX[39] = {1.49216676, 1.51851678, 1.5579617, 1.64857316, 1.57100117, 1.34270084, 1.20389056, 1.31372344, 1.60960639, 1.69372451, 1.50360715, 1.40052497, 1.91936755, 2.08155727, 2.14409018, 1.94486308, 1.28940415, 0.881582916, 1.1271081, 1.22097564, 1.2776829, 1.29637802, 0.991464615, 1.20402527, 1.50281775, 1.37897241, 1.31928062, 1.39449644, 1.83114743, 1.72280324, 1.77596223, 1.78317356, 1.86322153, 2.09625506, 2.29837847, 2.3948648, 2.29740524, 2.27718377, 2.28102875};
float lightDownY[39] = {-9.08133316, -9.17093277, -9.19765282, -9.16235733, -8.8916502, -8.50715542, -8.13300896, -7.63710642, -7.43097448, -7.38268232, -7.17487764, -7.03241444, -6.91469002, -6.74528313, -6.63269806, -6.31388855, -6.22272205, -6.11690521, -5.66783381, -5.53948355, -5.46463871, -5.14824724, -4.86077309, -4.53954124, -4.26067877, -3.97847509, -3.66393256, -3.4347527, -3.40032697, -3.12122893, -2.94386029, -2.69970226, -2.65779161, -2.65245414, -2.61271787, -2.55790257, -2.47153187, -2.53107238, -2.52175069};
float lightDownZ[39] = {2.65483332, 2.29338336, 2.30436826, 2.57005787, 2.93304062, 3.61912847, 4.52538967, 4.88377285, 4.72064114, 4.36944866, 3.94361401, 3.63952971, 2.71867085, 1.83106959, 0.198748738, -1.95787585, -4.001513, -5.21005917, -6.43104124, -7.71172905, -8.63220978, -9.38454723, -9.78518295, -10.6116276, -11.1781397, -11.0646982, -10.7902889, -11.1232023, -11.5812416, -11.6138687, -11.3877077, -11.2623959, -11.2286768, -11.2020741, -11.021452, -10.7450161, -10.5185108, -10.2909575, -10.16467};

float min(float a, float b) {
	return a < b ? a : b;
}

float max(float a, float b) {
	return a > b ? a : b;
}

float minArray(float *array, int begin, int end) {
	float min = array[begin];
	for (int i = begin + 1; i < end; i++) {
		if(array[i] < min) { min = array[i]; }
	}
	return min;
}

float maxArray(float *array, int begin, int end) {
	double max = array[begin];
	for (int i = begin + 1; i < end; i++) {
		if(array[i] > max) { max = array[i]; }
	}
	return max;
}

float average(float *array, int begin, int end) {
	float sum = 0;
	int i;
	for(i = begin; i < end; i++) {
		sum += array[i];
	}
	return sum / (float) end - begin;
}

void ewma(float *array, int size, float *result) {

	int s = size < 6 ? size : 6;
	float forecasted = average(array, 0, s);
	float smoothed = 0;

	int i;

	for (i = 1; i <= size; i++) {
		smoothed = EWMA_ALPHA * array[i - 1] + (1.0 - EWMA_ALPHA) * forecasted;
		forecasted = smoothed;
		result[i - 1] = smoothed;
	}

}

double dtwDistance1(float *ax, float *ay, float *az, int sa, float *bx, float *by, float *bz, int sb, int window) {

	float acc[sb][sa];
	float dist;

	acc[0][0] = pow(ax[0] - bx[0], 2.0) + pow(ay[0] - by[0], 2.0) + pow(az[0] - bz[0], 2.0);

	// Accumulated distance - Row 0
	for (int i = 1; i < sa; i++) {
		dist = pow(ax[i] - bx[0], 2.0) + pow(ay[i] - by[0], 2.0) + pow(az[i] - bz[0], 2.0);
		acc[0][i] = acc[0][i - 1] + dist;
	}

	// Accumulated distance - Row 0
	for (int i = 1; i < sb; i++) {
		dist = pow(ax[0] - bx[i], 2.0) + pow(ay[0] - by[i], 2.0) + pow(az[0] - bz[i], 2.0);
		acc[i][0] = acc[i - 1][0] + dist;
	}

	// Accumlated distance - Remaining
	float m;
	for (int i = 1; i < sb; i++) {
		for (int j = 1; j < sa; j++) {
			dist = pow(ax[j] - bx[i], 2.0) + pow(ay[j] - by[i], 2.0) + pow(az[j] - bz[i], 2.0);
			m = min(min(acc[i - 1][j - 1],
					acc[i - 1][j]),
					acc[i][j - 1]);
			acc[i][j] = m + dist;
		}
	}

	return sqrt(acc[sb - 1][sa - 1]);

}

float dtwDistance(float *ax, float *ay, float *az, int sa, float *bx, float *by, float *bz, int sb, int window) {

	float acc[sa][sb];
	float dist;
	int maxi, mini;
	window = max(window, abs(sa - sb));

	// Temp
	for (int i = 0; i < sa; i++) {
		for (int j = 0; j < sb; j++) {
			acc[i][j] = INFINITY;
		}
	}

	acc[0][0] = pow(ax[0] - bx[0], 2.0) + pow(ay[0] - by[0], 2.0) + pow(az[0] - bz[0], 2.0);

	// Row 0
	mini = min(window, sb);
	for (int i = 1; i < mini; i++) {
		dist = pow(ax[0] - bx[i], 2.0) + pow(ay[0] - by[i], 2.0) + pow(az[0] - bz[i], 2.0);
		acc[0][i] = acc[0][i - 1] + dist;
	}

	// Column 0
	mini = min(window, sa);
	for (int i = 1; i < mini + 1; i++) {
		dist = pow(ax[i] - bx[0], 2.0) + pow(ay[i] - by[0], 2.0) + pow(az[i] - bz[0], 2.0);
		acc[i][0] = acc[i - 1][0] + dist;
	}

	// Accumlated distance - Remaining
	float m;
	for (int i = 1; i < sa; i++) {
		mini = max(1, i - window);
		maxi = min(sb, i + window);
		for (int j = mini; j < maxi; j++) {
			dist = pow(ax[i] - bx[j], 2.0) + pow(ay[i] - by[j], 2.0) + pow(az[i] - bz[j], 2.0);
			m = min(
					min(acc[i - 1][j],
							acc[i][j - 1]),
							acc[i - 1][j - 1]);
			acc[i][j] = m + dist;
		}
	}

	return sqrt(acc[sa - 1][sb - 1]);

}

float LBKeogh(float *x, int sx, float *y, int sy, int r) {

	double sum = 0;
	int li, mi;
	double lowerBound, upperBound;

	for (int i = 0; i < sx; i++) {

		li = (i - r) >= 0 ? (i - r) : 0;
		mi = (i + r) <= sy ? (i + r) : sy;

		lowerBound = minArray(y, li, mi);
		upperBound = maxArray(y, li, mi);

		if(x[i] > upperBound) {
			sum += pow(x[i] - upperBound, 2);
		} else if(x[i] < lowerBound) {
			sum += pow(x[i] - lowerBound, 2);
		}

	}

	return sqrt(sum);
}

float LBKeogh3D(float *ax, float *ay, float *az, int sa, float *bx, float *by, float *bz, int sb, int r) {
	float lx = LBKeogh(ax, sa, bx, sb, r);
	float ly = LBKeogh(ay, sa, by, sb, r);
	float lz = LBKeogh(az, sa, bz, sb, r);
	return lx + ly + lz;
}

int knn(float inputX[], float inputY[], float inputZ[], int size, float *dist) {

	int answer;
	float distance = INFINITY;
	float minDistance = INFINITY;
	int lbr = 30;

	float* pointersX[NUMBER_OF_GESTURES] = {doorOpenX, doorCloseX, lightUpX, lightDownX};
	float* pointersY[NUMBER_OF_GESTURES] = {doorOpenY, doorCloseY, lightUpY, lightDownY};
	float* pointersZ[NUMBER_OF_GESTURES] = {doorOpenZ, doorCloseZ, lightUpZ, lightDownZ};

	int sizes[NUMBER_OF_GESTURES] = {35, 35, 36, 39};
	int window = 4; // Does not matter for DTW1

	for(int i = 0; i < NUMBER_OF_GESTURES; i++) {
		if(LBKeogh3D(inputX, inputY, inputZ, size, pointersX[i], pointersY[i], pointersZ[i], sizes[i], lbr) < minDistance) {
			distance = dtwDistance1(inputX, inputY, inputZ, size, pointersX[i], pointersY[i], pointersZ[i], sizes[i], window);
			if(distance < minDistance) {
				minDistance = distance;
				answer = i;
			}
		}
	}

	*dist = minDistance;

	// Checking for NaN
	if(minDistance != minDistance) {
		return minDistance;
	}

	// Negative if the distance is infinity
	return answer * (minDistance == INFINITY ? -1 : 1);

}
