/*
 * DTW.c
 *
 *  Created on: 17 de jan de 2017
 *      Author: Alan
 */

#include "DTW.h"

//// Door Open
//float doorOpenX[29] = {-2.74866652, -2.82106662, -2.96774673, -3.2474227, -3.49119592, -3.65883708, -3.914186, -4.26393032, -4.62275124, -4.70592594, -4.48814821, -4.1377039, -4.10839272, -4.06987476, -4.05191231, -3.81433868, -3.40203714, -3.06842589, -2.88889813, -2.57122874, -2.18086004, -1.83560205, -1.51292145, -0.897045016, -0.471931517, -0.0903520584, 0.329753548, 0.68382746, 0.775679231};
//float doorOpenY[29] = {-1.98033345, -2.10623336, -2.02636337, -1.95845437, -2.02191806, -1.95534265, -2.01373982, -2.08761787, -2.16033244, -2.17823267, -2.00476289, -1.69733405, -1.49713385, -1.50699365, -1.3218956, -0.994326949, -0.600028872, -0.27902022, 0.0386858359, 0.207080096, 0.501956105, 0.798369288, 1.04485846, 1.21440089, 1.26108062, 1.30575645, 1.38502955, 1.28152072, 1.08006454};
//float doorOpenZ[29] = {10.1113329, 10.0389328, 9.90425301, 9.83397675, 9.90178394, 9.8712492, 9.82887459, 9.70021248, 9.59214878, 9.67850399, 9.687953, 9.44856739, 9.50899696, 9.49729824, 9.59110928, 9.76477623, 9.94334316, 10.0353403, 10.0517387, 10.0212173, 10.0448523, 10.2713966, 10.4389772, 10.3972845, 10.4280987, 10.6026688, 10.6258678, 10.5821075, 10.6504755};
//
//// Door Close
//float doorCloseX[43] = {0.624833345, 0.455383331, 0.387768328, 0.463437825, 0.5794065, 1.16758454, 2.14330912, 2.95231652, 3.50962162, 3.82173514, 4.03721476, 4.02005053, 3.58503532, 2.85452461, 2.3761673, 2.09831715, 1.63082206, 0.895575464, -0.0570971668, -0.921968043, -1.34137762, -1.82696438, -2.523875, -3.14371252, -3.47259879, -3.66381931, -4.09767342, -4.68037128, -5.23225975, -5.48058176, -5.29740715, -5.1661849, -5.29932928, -5.37753057, -5.20727158, -5.01609039, -5.01726341, -4.98808432, -4.77865887, -4.30206108, -3.79144263, -3.58100986, -3.48470688};
//float doorCloseY[43] = {-1.82716668, -2.02301669, -2.05811167, -2.00767827, -1.96937478, -1.36356235, -0.660493612, -0.0813455358, 0.210058123, 0.420040697, 0.55802846, 0.615619898, 0.622933924, 0.583053768, 0.591137648, 0.836796343, 1.14675748, 1.16273022, 0.861911178, 0.69933784, 0.768536508, 0.735975564, 0.368182898, -0.075271979, -0.394690394, -0.37228328, -0.332598299, -0.784818828, -0.942373157, -1.13966119, -1.20876288, -1.27513397, -1.53759384, -1.7663157, -1.91442096, -1.83209467, -1.92746627, -2.01822639, -2.00375843, -1.76563096, -1.62294161, -1.6040591, -1.57884133};
//float doorCloseZ[43] = {10.0303335, 10.0092335, 9.97646332, 9.92952442, 10.0166674, 10.1946669, 10.3612671, 10.5588875, 10.7752209, 10.6506548, 10.3324585, 10.2807207, 10.4755049, 10.5248537, 10.3013973, 10.3909779, 10.4206848, 10.1534796, 9.72943592, 9.7746048, 10.0702238, 10.0611563, 10.0458097, 10.2120667, 9.84544659, 9.54081249, 9.69656849, 9.6405983, 9.39741898, 9.53019333, 9.71013546, 9.87209511, 10.1504669, 10.1953268, 9.97772884, 9.75041008, 9.63928699, 9.489501, 9.46865082, 9.52005577, 9.74503899, 10.0075274, 10.1792688};
//
//// Light Up
//float lightUpX[27] = {-1.15983343, -0.976883411, -0.944818377, -1.14437282, -1.42806101, -1.74964273, -1.87574995, -1.83802497, -1.6796174, -1.58373213, -1.58261251, -1.50082874, -1.35358012, -1.20850611, -1.09495425, -0.895467997, -0.719827592, -0.569879293, -0.500915527, -0.39564088, -0.12694861, 0.0791359767, 0.175395191, 0.197776631, 0.165443644, 0.0528105535, -0.0500326082};
//float lightUpY[27] = {-0.842666626, -0.877866626, -0.881506622, -0.929054618, -1.00433826, -1.08103681, -1.06872571, -1.02710795, -0.89597553, -0.840182841, -0.885128021, -1.05458963, -1.10421276, -1.11494899, -1.14346433, -1.19342506, -1.27039754, -1.50127828, -1.72889483, -1.85222638, -2.13655853, -2.32359099, -2.53551364, -2.81585956, -3.10810161, -3.45367122, -3.86056972};
//float lightUpZ[27] = {11.7701664, 11.2601166, 11.5420818, 12.2164574, 13.0605202, 13.7743645, 14.2590551, 14.2533388, 14.015337, 13.8007355, 13.5455151, 13.1148605, 12.7384024, 12.5678816, 12.3555174, 11.8558617, 11.335103, 10.8145723, 10.3032007, 9.7412405, 8.93986797, 7.98890734, 7.21823502, 6.5107646, 6.00053501, 5.70937443, 5.41856194};
//
//// Light Down
//float lightDownX[39] = {-0.154500008, -0.219150007, -0.234405011, -0.248083502, -0.209658444, -0.167760909, -0.105432637, -0.139802843, -0.154861987, -0.0934033915, -0.0383823738, -0.0838676617, -0.160707369, -0.187495157, -0.176246613, -0.066372633, -0.0074608447, 0.00977740902, -0.0621558167, -0.0435090736, -0.0484563522, -0.0939194486, -0.0777436122, 0.185579479, 0.411905646, 0.366333961, 0.250433773, 0.370303631, 0.640212536, 0.673148751, 0.723204136, 0.713242888, 0.685270011, 0.659689009, 0.785782337, 0.817047656, 0.838933349, 0.914253354, 0.879977345};
//float lightDownY[39] = {-7.41149998, -7.58804989, -7.55863476, -7.50504446, -7.37453127, -7.18117189, -7.00082016, -6.88057423, -6.63740206, -6.37718153, -6.23102713, -6.1017189, -5.99620342, -5.80234241, -5.60963964, -5.38474798, -5.30232382, -5.1726265, -5.12083864, -5.05458689, -4.93321085, -4.84524775, -4.73867321, -4.56807137, -4.36765003, -4.28735495, -4.17714834, -3.89000392, -3.54800272, -3.37460184, -3.24122143, -3.06685495, -2.95079851, -2.83655882, -2.62159109, -2.53711367, -2.46597958, -2.41918564, -2.39242983};
//float lightDownZ[39] = {-5.6826663, -5.77186632, -5.88230658, -5.76761436, -5.54933023, -5.34553099, -5.22387171, -5.08471012, -4.98729706, -4.87110806, -4.8167758, -4.77574301, -4.86702013, -5.01791382, -5.18953991, -5.23767805, -5.57137442, -6.07496214, -6.61347342, -7.08943129, -7.4856019, -7.91892147, -8.14724541, -8.34307194, -8.70815086, -9.38370514, -9.69759369, -9.66531563, -9.80772114, -9.97640514, -10.1184835, -10.2149382, -10.267457, -10.4032202, -10.5402536, -10.7561779, -10.8443241, -11.0860271, -11.4982185};


float doorOpenX[33] = {6.73183346, 6.67128372, 6.46689844, 6.40182877, 6.38028002, 6.50019598, 7.05813694, 7.59269571, 7.62188721, 6.94332123, 6.27332497, 5.71732759, 5.37312937, 4.91919041, 4.40043354, 4.31330347, 4.38731241, 4.2741189, 4.20388317, 4.19971848, 4.01980305, 3.10786223, 2.25050354, 1.27235246, 0.761646688, 0.61415267, 0.795906901, 1.19013476, 1.22909439, 1.21136606, 1.51695621, 1.92886937, 2.11820865};
float doorOpenY[33] = {1.31183326, 1.11928332, 1.27549827, 1.55884886, 1.77819419, 1.90773594, 1.92041516, 1.86929059, 2.01650333, 1.87355232, 1.74048662, 1.3503406, 1.11623847, 1.04236698, 1.33265686, 1.37685978, 1.45580184, 1.14206123, 1.31844282, 1.91290998, 1.83703697, 1.09392583, 0.291748077, 0.168223649, 0.303756565, 0.494629592, 0.112240724, -0.0324314944, 0.0162979532, 0.137408569, 0.288185984, 0.264730185, 0.0713111311};
float doorOpenZ[33] = {8.21033382, 8.03323364, 8.23626328, 8.62438393, 9.27406883, 9.41984844, 8.65189362, 7.59832573, 7.44582796, 8.3020792, 8.90145588, 8.66701889, 7.98991299, 8.04093933, 9.00065708, 9.66345978, 9.15542221, 8.65879536, 9.70315647, 10.8452091, 11.2366467, 10.3016529, 9.3921566, 9.83850956, 11.3539572, 11.6197701, 10.8968391, 9.95578766, 9.94205093, 10.6224356, 10.9547043, 10.6472931, 10.6031055};

float doorCloseX[37] = {1.05116677, 0.900816739, 1.03557169, 1.4179002, 1.70953012, 1.69467103, 1.6722697, 2.07958889, 3.02171206, 3.41119862, 3.41683912, 3.45678735, 3.44575119, 3.18902588, 2.88331819, 2.71132278, 2.86992598, 3.15194821, 3.49036384, 3.65825462, 3.56277823, 3.53194475, 3.84936142, 4.58455324, 5.24618721, 5.7783308, 6.35183144, 6.77728176, 7.17109728, 7.57876778, 7.74713755, 7.46599627, 7.01119709, 7.02883816, 7.70418644, 8.4349308, 8.91945171};
float doorCloseY[37] = {-0.488666654, -0.627066672, -0.405946672, -0.086162664, 0.0536861345, 0.124580294, 0.231206208, 0.461844355, 0.785291016, 0.897703707, 0.874392569, 0.834074795, 0.766852379, 0.69879669, 0.627157688, 0.577010393, 0.427907288, 0.4705351, 0.761374593, 0.946962237, 1.07687354, 1.02381146, 0.887668014, 0.936367571, 1.21945727, 1.45362008, 1.53953409, 1.47667384, 1.42367172, 1.35357022, 1.22349918, 0.967449427, 0.701214612, 0.682850242, 0.777995169, 0.997596622, 1.17531765};
float doorCloseZ[37] = {10.6581659, 10.634716, 10.7443008, 10.8420105, 10.9254074, 11.0377855, 11.0774498, 10.829215, 10.3404503, 10.4813156, 10.6549206, 10.5574446, 10.1802111, 10.0001478, 10.3031034, 10.725172, 9.9856205, 9.21593475, 9.05215454, 9.195508, 9.94085598, 10.7205992, 10.5584192, 9.88389397, 9.92472553, 10.5563078, 10.7254152, 10.1987906, 9.30815315, 8.36670685, 7.29669476, 7.00668621, 7.29568005, 7.21897602, 6.7362833, 6.27839851, 6.16487885};

float lightUpX[36] = {-0.0341666676, -0.122916669, -0.233041674, -0.148129165, 0.0613095872, -0.0110832909, -0.121758305, -0.337230802, -0.185061559, 0.131456912, 0.200019836, 0.182013884, 0.220409721, 0.223286808, 0.294300765, 0.194010541, 0.357807368, 0.652465165, 0.792725623, 0.80090791, 0.800635517, 0.920444846, 0.977311373, 0.924117982, 0.826882601, 0.653817832, 0.442672491, 0.468870729, 0.385209501, 0.269646645, -0.0152473506, -0.0976731405, 0.117628805, 0.0973401666, -0.129861891, -0.21990332};
float lightUpY[36] = {-1.33500004, -1.29449999, -1.23014998, -1.18810499, -1.19767356, -1.35137153, -1.39596009, -1.51117206, -1.63382041, -1.68667424, -1.97567201, -2.32197046, -2.62137938, -2.98996544, -3.37397575, -3.73878312, -4.13214827, -4.48250389, -4.92275286, -5.40792704, -5.79554892, -6.15088415, -6.48361874, -6.85153294, -7.18107319, -7.45375109, -7.71062565, -7.878438, -8.15190697, -8.27733517, -8.44613457, -8.56729412, -8.60110569, -8.77477455, -9.03734207, -9.2901392};
float lightUpZ[36] = {12.0678329, 12.0324831, 12.2537384, 12.5826168, 12.8728313, 12.6529818, 12.583087, 12.8551607, 13.1446123, 13.3982286, 13.2517605, 12.7382326, 12.1267624, 11.5937338, 11.028614, 10.5040302, 9.84882069, 8.87117481, 7.59882259, 6.47717571, 5.42202282, 4.41341591, 3.56639123, 2.73347378, 2.15043163, 1.60430217, 1.03601158, 0.299208105, -0.282554328, -1.04378796, -1.54965162, -1.6247561, -1.7283293, -1.64183056, -1.4762814, -1.363397};

float lightDownX[32] = {0.754166663, 0.857916653, 0.858541667, 0.813979149, 0.857785404, 0.78644979, 0.69151485, 0.775060415, 1.05854225, 0.878979564, 0.525285721, 0.41870001, 0.155090004, -0.350436985, -0.722305894, -0.730614126, -0.712429881, -0.528700888, -0.220090628, -0.169063434, -0.304344416, -0.483041078, -0.446128756, -0.327290118, -0.307103068, -0.196972147, -0.0568805002, 0.266183645, 0.570328534, 0.73822999, 0.726760983, 0.757732689};
float lightDownY[32] = {-8.65283394, -8.53198338, -8.55538845, -8.66777229, -8.63844013, -8.50690842, -8.16283607, -7.84698534, -7.77288961, -7.77802277, -7.63161612, -7.38813114, -7.23269176, -7.22888422, -6.97121906, -6.56285334, -6.17799759, -5.92359829, -5.69151878, -5.29806328, -5.00164413, -4.785151, -4.55860567, -4.38202381, -4.20741653, -4.07619143, -3.88233399, -3.81563377, -3.69094372, -3.5376606, -3.34936237, -3.28055358};
float lightDownZ[32] = {3.56483316, 3.76438332, 3.71506834, 3.34154797, 3.17308354, 3.47815847, 3.96771097, 3.94139767, 3.00497842, 2.10348487, 1.79043937, 1.48130751, -0.103084728, -1.66215932, -2.31851149, -2.75095797, -3.71967053, -5.04576969, -6.3580389, -7.55562735, -9.18593884, -10.6751575, -11.5856104, -12.2739277, -12.5697498, -12.3118248, -11.8492775, -11.3214941, -10.7990456, -10.5893316, -10.7935324, -11.1194725};


float min(float a, float b) {
	return a < b ? a : b;
}

float max(float a, float b) {
	return a > b ? a : b;
}

float minArray(float *array, int begin, int end) {
	float min = array[begin];
	for (int i = begin + 1; i < end; i++) {
		if(array[i] < min) { min = array[i]; }
	}
	return min;
}

float maxArray(float *array, int begin, int end) {
	double max = array[begin];
	for (int i = begin + 1; i < end; i++) {
		if(array[i] > max) { max = array[i]; }
	}
	return max;
}

float average(float *array, int begin, int end) {
	float sum = 0;
	int i;
	for(i = begin; i < end; i++) {
		sum += array[i];
	}
	return sum / (float) (end - begin);
}

void ewma(float *array, int size, float *result) {

	int s = size < 6 ? size : 6;
	float forecasted = average(array, 0, s);
	float smoothed = 0;

	int i;

	for (i = 1; i <= size; i++) {
		smoothed = EWMA_ALPHA * array[i - 1] + (1.0 - EWMA_ALPHA) * forecasted;
		forecasted = smoothed;
		result[i - 1] = smoothed;
	}

}

double dtwDistance1(float *ax, float *ay, float *az, int sa, float *bx, float *by, float *bz, int sb, int window) {

	float acc[sb][sa];
	float dist;

	acc[0][0] = pow(ax[0] - bx[0], 2.0) + pow(ay[0] - by[0], 2.0) + pow(az[0] - bz[0], 2.0);

	// Accumulated distance - Row 0
	for (int i = 1; i < sa; i++) {
		dist = pow(ax[i] - bx[0], 2.0) + pow(ay[i] - by[0], 2.0) + pow(az[i] - bz[0], 2.0);
		acc[0][i] = acc[0][i - 1] + dist;
	}

	// Accumulated distance - Row 0
	for (int i = 1; i < sb; i++) {
		dist = pow(ax[0] - bx[i], 2.0) + pow(ay[0] - by[i], 2.0) + pow(az[0] - bz[i], 2.0);
		acc[i][0] = acc[i - 1][0] + dist;
	}

	// Accumlated distance - Remaining
	float m;
	for (int i = 1; i < sb; i++) {
		for (int j = 1; j < sa; j++) {
			dist = pow(ax[j] - bx[i], 2.0) + pow(ay[j] - by[i], 2.0) + pow(az[j] - bz[i], 2.0);
			m = min(min(acc[i - 1][j - 1],
					acc[i - 1][j]),
					acc[i][j - 1]);
			acc[i][j] = m + dist;
		}
	}

	return sqrt(acc[sb - 1][sa - 1]);

}

float dtwDistance(float *ax, float *ay, float *az, int sa, float *bx, float *by, float *bz, int sb, int window) {

	float acc[sa][sb];
	float dist;
	int maxi, mini;
	window = max(window, abs(sa - sb));

	// Temp
	for (int i = 0; i < sa; i++) {
		for (int j = 0; j < sb; j++) {
			acc[i][j] = INFINITY;
		}
	}

	acc[0][0] = pow(ax[0] - bx[0], 2.0) + pow(ay[0] - by[0], 2.0) + pow(az[0] - bz[0], 2.0);

	// Row 0
	mini = min(window, sb);
	for (int i = 1; i < mini; i++) {
		dist = pow(ax[0] - bx[i], 2.0) + pow(ay[0] - by[i], 2.0) + pow(az[0] - bz[i], 2.0);
		acc[0][i] = acc[0][i - 1] + dist;
	}

	// Column 0
	mini = min(window, sa);
	for (int i = 1; i < mini + 1; i++) {
		dist = pow(ax[i] - bx[0], 2.0) + pow(ay[i] - by[0], 2.0) + pow(az[i] - bz[0], 2.0);
		acc[i][0] = acc[i - 1][0] + dist;
	}

	// Accumlated distance - Remaining
	float m;
	for (int i = 1; i < sa; i++) {
		mini = max(1, i - window);
		maxi = min(sb, i + window);
		for (int j = mini; j < maxi; j++) {
			dist = pow(ax[i] - bx[j], 2.0) + pow(ay[i] - by[j], 2.0) + pow(az[i] - bz[j], 2.0);
			m = min(
					min(acc[i - 1][j],
							acc[i][j - 1]),
							acc[i - 1][j - 1]);
			acc[i][j] = m + dist;
		}
	}

	return sqrt(acc[sa - 1][sb - 1]);

}

float LBKeogh(float *x, int sx, float *y, int sy, int r) {

	double sum = 0;
	int li, mi;
	double lowerBound, upperBound;

	for (int i = 0; i < sx; i++) {

		li = (i - r) >= 0 ? (i - r) : 0;
		mi = (i + r) <= sy ? (i + r) : sy;

		lowerBound = minArray(y, li, mi);
		upperBound = maxArray(y, li, mi);

		if(x[i] > upperBound) {
			sum += pow(x[i] - upperBound, 2);
		} else if(x[i] < lowerBound) {
			sum += pow(x[i] - lowerBound, 2);
		}

	}

	return sqrt(sum);
}

float LBKeogh3D(float *ax, float *ay, float *az, int sa, float *bx, float *by, float *bz, int sb, int r) {
	float lx = LBKeogh(ax, sa, bx, sb, r);
	float ly = LBKeogh(ay, sa, by, sb, r);
	float lz = LBKeogh(az, sa, bz, sb, r);
	return lx + ly + lz;
}

int knn(float inputX[], float inputY[], float inputZ[], int size) {

	int answer;
	float distance = INFINITY;
	float minDistance = INFINITY;
	int lbr = 30;

	float* pointersX[NUMBER_OF_GESTURES] = {doorOpenX, doorCloseX, lightUpX, lightDownX};
	float* pointersY[NUMBER_OF_GESTURES] = {doorOpenY, doorCloseY, lightUpY, lightDownY};
	float* pointersZ[NUMBER_OF_GESTURES] = {doorOpenZ, doorCloseZ, lightUpZ, lightDownZ};

	int sizes[NUMBER_OF_GESTURES] = {33, 37, 36, 32};//{29, 43, 27, 39};
	int window = 4; // Does not matter for DTW1

	for(int i = 0; i < NUMBER_OF_GESTURES; i++) {
//		if(LBKeogh3D(inputX, inputY, inputZ, size, pointersX[i], pointersY[i], pointersZ[i], sizes[i], lbr) < minDistance) {
			distance = dtwDistance1(inputX, inputY, inputZ, size, pointersX[i], pointersY[i], pointersZ[i], sizes[i], window);
			if(distance < minDistance) {
				minDistance = distance;
				answer = i;
			}
//		}
	}

	// Checking for NaN
//	if(minDistance != minDistance) {
//		return minDistance;
//	}
//
//	// Negative if the distance is infinity
//	return answer * (minDistance == INFINITY ? -1 : 1);

	return answer;

}
