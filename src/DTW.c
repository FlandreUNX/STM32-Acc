/*
 * DTW.c
 *
 *  Created on: 17 de jan de 2017
 *      Author: Alan
 */

#include "DTW.h"

// Normal O
float normalOx[100] = {0.266833335, 0.375783324, 0.515048325, 0.444533825, 0.260173678, 0.137121573, 0.143985093, 0.139789566, 0.250852704, 0.397596896, 0.677317858, 1.08612251, 1.3662858, 1.3914001, 1.27398002, 1.24878597, 1.14415014, 0.929905117, 0.64193356, 0.545353472, 0.525747418, 0.410023183, 0.218016222, -0.135388643, -0.457772076, -0.683440447, -0.838408351, -0.943885863, -1.16772008, -1.45340407, -1.65338278, -1.88336802, -2.02635765, -2.17145038, -2.13201523, -1.99941063, -1.90358746, -1.6925112, -1.5387578, -1.50313044, -1.32519126, -1.26063395, -1.15544379, -1.12381065, -0.996667445, -0.769667208, -0.553767025, -0.435636908, -0.36794582, -0.152562082, 0.127206534, 0.203044578, 0.292131215, 0.492491841, 0.644744277, 0.778321028, 0.901824713, 1.11427736, 1.34999418, 1.53299594, 1.82309711, 1.993168, 2.13321757, 2.12325239, 1.8882767, 1.6997937, 1.63385558, 1.83369887, 1.98558915, 1.94191241, 1.80633867, 1.59743702, 1.35520589, 1.19764411, 1.21635091, 1.37944567, 1.49661195, 1.46762836, 1.40833986, 1.50483787, 1.47938645, 1.38657045, 1.36659932, 1.41561949, 1.43793368, 1.42655361, 1.14258754, 0.928811312, 0.974167943, 1.02691758, 1.12684226, 1.01678956, 0.930752695, 0.888526917, 0.74196887, 0.675378203, 0.610764742, 0.0375353321, -0.432725251, -0.857907653};
float normalOy[100] = {-9.89233303, -9.87063313, -9.85844326, -9.94890976, -10.0242367, -10.0049658, -10.0484762, -10.0459337, -10.0351534, -10.0546074, -10.1402254, -10.2391577, -10.2814102, -10.3229876, -10.3460913, -10.5032635, -10.7032843, -10.9062986, -11.0904093, -11.2222862, -11.1676006, -10.9943209, -10.9420242, -10.9294167, -10.9355917, -10.8139143, -10.7017403, -10.6292181, -10.5544529, -10.4631166, -10.3961811, -10.3973265, -10.3531284, -10.4241896, -10.3299322, -10.2009525, -10.1616669, -10.0681667, -9.96971703, -9.91880226, -9.74216175, -9.67251301, -9.67175865, -9.51523113, -9.38166142, -9.15316296, -8.94521427, -8.71565056, -8.45595551, -8.20216846, -8.16851807, -8.21396255, -8.13177395, -8.10724163, -8.22506905, -8.34954834, -8.27468395, -8.12027931, -8.04819584, -8.1297369, -8.08481598, -8.03837109, -8.12885952, -8.29120159, -8.46784115, -8.4894886, -8.38464165, -8.25724888, -8.36907387, -8.47735119, -8.70614624, -8.96830273, -9.21481228, -9.39336872, -9.51835823, -9.58185101, -9.65929604, -9.8395071, -10.1126547, -10.2318583, -10.4533005, -10.67731, -10.768117, -10.564682, -10.3412771, -10.2238941, -10.477726, -10.6524086, -10.6606865, -10.6514807, -10.6180363, -10.8556252, -11.0819378, -11.2043562, -11.3650494, -11.3545341, -11.1071739, -11.0810223, -10.9307156, -10.7805014};
float normalOz[100] = {1.10133338, 1.04393339, 1.06075335, 1.20452738, 1.20916915, 1.27241838, 1.32569289, 1.33898497, 1.33028948, 1.40520263, 1.40664184, 1.41964936, 1.4677546, 1.59442818, 1.59309971, 1.45116985, 1.36081886, 1.42057323, 1.30340123, 1.37738085, 1.32716656, 1.33101654, 1.23771155, 0.899398088, 0.79157865, 0.884105086, 0.927873552, 1.05451155, 1.00515807, 0.859610617, 0.658727407, 0.320109189, -0.0399235673, -0.192946494, -0.22806254, -0.393643767, -0.42555064, -0.546885431, -0.667819798, -0.584473848, -0.589131713, -0.670392215, -0.637274563, -0.824092209, -0.903864563, -1.01370513, -1.08159363, -1.05711555, -1.14498091, -1.15248656, -1.10374057, -1.03061843, -0.979432881, -0.934603035, -0.951222122, -1.04085553, -1.04659891, -1.11961925, -1.1947335, -1.1993134, -1.08851933, -0.776963532, -0.594874501, -0.584412158, -0.760088503, -0.721061945, -0.534743369, -0.338320345, -0.116824239, -0.01877697, -0.03414388, 0.0150992824, 0.247569501, 0.602298617, 0.907609046, 0.785326362, 0.549728453, 0.339809924, 0.24386695, 0.329706848, 0.599794805, 0.812856317, 0.988999426, 1.01329958, 0.865309715, 0.707716823, 0.768401802, 0.97888124, 1.14121687, 1.28185177, 1.37729621, 1.4621073, 1.51847506, 1.65993249, 1.7019527, 1.82736683, 1.80415678, 1.8659097, 1.81913686, 1.68139577};

// Fast O
float fastOx[35] = {2.0855, 1.54384995, 1.31169498, 1.75218654, 3.24253058, 5.20677137, 6.50373983, 6.20261765, 4.10483217, 0.773382545, -2.36863208, -4.61004257, -5.46202993, -5.84542084, -6.43179464, -7.37325621, -7.62127924, -7.14989567, -6.13292694, -4.87204885, -3.48243427, -1.85570395, -0.119992748, 2.07000494, 3.9630034, 5.15610218, 6.22827148, 7.00578976, 7.02205276, 6.42743683, 5.25220585, 3.33454418, 1.10418093, -0.949073255, -2.28435135};
float fastOy[35] = {-10.0168333, -9.82578373, -9.50904846, -9.39233398, -9.89863396, -11.2280436, -13.709631, -15.4917412, -16.7392197, -17.6124535, -18.1697178, -16.6938019, -14.3676615, -11.4793625, -9.22355366, -7.85148764, -6.3000412, -4.48202896, -2.8134203, -1.4053942, -0.314775944, 0.502656877, 0.99985981, 0.465901881, -0.59486866, -2.555408, -4.60578585, -6.86605024, -9.909235, -12.8314648, -14.8770256, -16.308918, -17.3112431, -17.6678696, -16.2615089};
float fastOz[35] = {1.15483332, 0.808383346, 0.38286835, 0.553007841, 0.984105468, 2.53087378, 4.60961151, 6.4907279, 7.2195096, 5.96565676, 3.50095963, 1.11867177, -0.317929775, -1.45855081, -2.16398549, -2.11478996, -1.72035301, -1.2522471, -1.11657298, -1.08760107, -0.980320752, -0.602224529, 0.346442819, 1.43950999, 2.19265699, 2.88786006, 3.55750203, 4.02325153, 4.33127594, 4.40889311, 3.8452251, 2.75165749, 1.70116019, 0.620812118, -0.240431517};

// Normal Z
float normalZx[91] = {-1.602, -1.41540003, -1.47977996, -1.74684596, -2.07779217, -2.45345449, -2.77641821, -3.0414927, -3.24204493, -3.43043137, -3.58630204, -3.65941143, -3.65358806, -3.55651164, -3.39855814, -3.12299061, -2.79809332, -2.37866521, -1.93206561, -1.58644593, -1.19751215, -0.724258482, -0.0989809334, 0.689713359, 1.44279933, 2.15595961, 2.78117156, 3.43781996, 4.11647415, 4.38153172, 4.50707245, 4.3879509, 4.09156561, 3.63209581, 3.07346702, 2.6104269, 2.33129883, 2.26490927, 2.17943645, 2.09560561, 1.94992387, 1.72794676, 1.62356269, 1.61349392, 1.33944571, 1.08461201, 1.04422843, 0.757959902, 0.266571939, -0.272399634, -0.598679721, -0.689075828, -0.698353112, -0.722847164, -0.850993037, -1.19869518, -1.2380867, -1.12466073, -1.4442625, -2.09098363, -2.72968841, -3.20078182, -3.5185473, -4.00198317, -4.5983882, -5.0608716, -5.37861013, -5.48402691, -5.35381889, -5.00767326, -4.45037127, -3.88925982, -3.3614819, -2.80003738, -2.16402626, -1.58081841, -1.33457291, -1.27320099, -1.2122407, -0.923568487, -0.607497931, -0.143248558, 0.445726037, 1.1190083, 1.6413058, 1.94691408, 1.98383987, 1.84168792, 1.61018157, 1.30112708, 1.05478895};
float normalZy[91] = {-9.96033287, -9.90623283, -9.92236328, -9.96965408, -10.1767578, -10.2527304, -10.2759113, -10.2351379, -10.1315966, -10.0921173, -10.1094818, -10.0916376, -10.1181469, -10.0527029, -9.83889198, -9.72822475, -9.62975693, -9.52482986, -9.52038097, -9.65826607, -9.83278656, -10.0239506, -10.0197659, -9.8338356, -9.45768452, -9.12837887, -8.88886547, -8.67320633, -8.25524426, -8.03167152, -7.91417027, -7.88291931, -7.96304321, -8.00413036, -8.32689095, -8.57382393, -8.5156765, -8.34597397, -8.34718227, -8.35702801, -8.3249197, -8.2994442, -8.32661057, -8.33962727, -8.57073879, -8.72051716, -8.88536263, -9.29775429, -9.87742805, -10.3941994, -10.7829399, -10.7790585, -10.7433405, -10.5953388, -10.5367374, -10.6997166, -10.8588018, -10.7301617, -10.7361135, -10.8602791, -11.1241951, -11.1709366, -11.0656557, -11.1119595, -11.2193718, -11.2615604, -11.2400923, -11.0330648, -10.7591457, -10.3094025, -9.8985815, -9.65900707, -9.58730507, -9.74111366, -9.59978008, -9.44084549, -9.44959164, -9.61471367, -9.62229919, -9.68160915, -9.60312653, -9.32918835, -9.09543228, -9.04580307, -9.15206242, -9.33444405, -9.62111092, -9.89077759, -10.1125441, -10.2467813, -10.2267475};
float normalZz[91] = {-0.930999994, -0.909699976, -0.900789976, -0.93355298, -0.881487072, -0.908040941, -0.815628648, -0.729940057, -0.627958059, -0.574570656, -0.588199437, -0.690739632, -0.792517722, -0.89376241, -0.883633673, -0.876543581, -0.865580499, -0.845906377, -0.727134466, -0.619994104, -0.472995877, -0.337097108, -0.18496798, -0.162477583, -0.0027343065, 0.27708599, 0.490960181, 0.613672137, 0.906570494, 1.2105993, 1.37841952, 1.31289363, 1.25502551, 1.01351786, 0.643462479, 0.360423744, 0.162296623, 0.0506076366, -0.0665746555, -0.043602258, 0.212478414, 0.460734874, 0.511514425, 0.457060099, 0.613942087, 0.846759439, 1.02473164, 1.15231216, 1.19961846, 1.12773287, 0.960412979, 0.708289087, 0.534802377, 0.446361661, 0.735453129, 0.913817227, 0.894672036, 1.04327047, 1.17128932, 1.19190252, 1.03833175, 0.672832251, 0.557982564, 0.552587807, 0.764811456, 0.89536804, 0.983757615, 1.15663028, 1.25964117, 1.43974876, 1.48482418, 1.45337689, 1.53336382, 1.78435469, 2.05604839, 2.1922338, 2.12556362, 1.86289454, 1.62202621, 1.45341837, 1.6173929, 2.03817511, 2.28472257, 2.28330588, 2.40831423, 2.55281997, 2.56097388, 2.50368166, 2.49657726, 2.47960401, 2.60872293};

// Fast Z
float fastZx[34] = {-4.132833, -3.00698304, -2.63888812, -3.89322186, -6.25625563, -9.16737938, -11.4391651, -12.0064154, -10.7774906, -8.55224323, -5.6085701, -1.96699905, 2.5501008, 6.69607067, 10.3242493, 12.9479742, 14.3375816, 14.2753067, 12.4677143, 9.27939987, 4.90558004, 0.475906134, -4.0318656, -8.71730614, -11.5561142, -12.3552799, -12.1106958, -10.9104872, -8.77434063, -5.51203823, -1.18842685, 3.08910108, 6.11937046, 7.60155964};
float fastZy[34] = {-10.4506674, -10.1024675, -10.0327272, -10.2929087, -10.7750359, -11.6705256, -12.1653681, -11.4947577, -10.6473303, -9.56813145, -8.28469181, -7.08028412, -5.39719868, -3.67003918, -1.72002745, -0.406019181, 0.666786611, 0.973750651, -0.527374625, -2.83816218, -6.31871319, -9.39709949, -12.2089701, -14.3782787, -15.0987949, -14.4931564, -13.6672096, -12.6960468, -11.4432325, -9.7112627, -8.41788387, -8.1965189, -8.62056351, -9.22939396};
float fastZz[34] = {-0.120999992, -0.414700001, -0.797290027, -0.594103038, 0.0101278601, 0.100089505, -0.325937361, -1.30815613, -2.91670942, -3.75469661, -2.70028758, -0.798201263, 2.09025908, 5.14718151, 6.07502699, 6.61051893, 6.72736311, 6.51515436, 5.95860815, 5.48502588, 4.29251814, 2.8067627, 1.96773386, 1.31741369, -0.0948104486, -1.31436729, -2.35105705, -3.45474005, -3.83131814, -2.39392281, 0.628253996, 4.12077808, 6.79654455, 8.00358105};

float min(float a, float b) {
	return a < b ? a : b;
}

float max(float a, float b) {
	return a > b ? a : b;
}

float average(float *array, int begin, int end) {
	float sum = 0;
	int i;
	for(i = begin; i < end; i++) {
		sum += array[i];
	}
	return sum / (float) end - begin;
}

void ewma(float *array, int size, float *result) {

	int s = size < 6 ? size : 6;
	float forecasted = average(array, 0, s);
	float smoothed = 0;

	int i;

	for (i = 1; i <= size; i++) {
		smoothed = EWMA_ALPHA * array[i - 1] + (1.0 - EWMA_ALPHA) * forecasted;
		forecasted = smoothed;
		result[i - 1] = smoothed;
	}

}

float dtwDistance(float *ax, float *ay, float *az, int sa, float *bx, float *by, float *bz, int sb, int window) {

	float acc[sa][sb];
	float dist;
	int maxi, mini;
	window = max(window, abs(sa - sb));

	// Temp
	for (int i = 0; i < sa; i++) {
		for (int j = 0; j < sb; j++) {
			acc[i][j] = INFINITY;
		}
	}

	acc[0][0] = pow(ax[0] - bx[0], 2.0) + pow(ay[0] - by[0], 2.0) + pow(az[0] - bz[0], 2.0);

	// Row 0
	mini = min(window, sb);
	for (int i = 1; i < mini; i++) {
		dist = pow(ax[0] - bx[i], 2.0) + pow(ay[0] - by[i], 2.0) + pow(az[0] - bz[i], 2.0);
		acc[0][i] = acc[0][i - 1] + dist;
	}

	// Column 0
	mini = min(window, sa);
	for (int i = 1; i < mini + 1; i++) {
		dist = pow(ax[i] - bx[0], 2.0) + pow(ay[i] - by[0], 2.0) + pow(az[i] - bz[0], 2.0);
		acc[i][0] = acc[i - 1][0] + dist;
	}

	// Accumlated distance - Remaining
	float m;
	for (int i = 1; i < sa; i++) {
		mini = max(1, i - window);
		maxi = min(sb, i + window);
		for (int j = mini; j < maxi; j++) {
			dist = pow(ax[i] - bx[j], 2.0) + pow(ay[i] - by[j], 2.0) + pow(az[i] - bz[j], 2.0);
			m = min(
					min(acc[i - 1][j],
							acc[i][j - 1]),
							acc[i - 1][j - 1]);
			acc[i][j] = m + dist;
		}
	}

	return sqrt(acc[sa - 1][sb - 1]);

}

float minArray(float *array, int begin, int end) {
	float min = array[begin];
	for (int i = begin + 1; i < end; i++) {
		if(array[i] < min) { min = array[i]; }
	}
	return min;
}

float maxArray(float *array, int begin, int end) {
	double max = array[begin];
	for (int i = begin + 1; i < end; i++) {
		if(array[i] > max) { max = array[i]; }
	}
	return max;
}

float LBKeogh(float *x, int sx, float *y, int sy, int r) {

	double sum = 0;
	int li, mi;
	double lowerBound, upperBound;

	for (int i = 0; i < sx; i++) {

		li = (i - r) >= 0 ? (i - r) : 0;
		mi = (i + r) <= sy ? (i + r) : sy;

		lowerBound = minArray(y, li, mi);
		upperBound = maxArray(y, li, mi);

		if(x[i] > upperBound) {
			sum += pow(x[i] - upperBound, 2);
		} else if(x[i] < lowerBound) {
			sum += pow(x[i] - lowerBound, 2);
		}

	}

	return sqrt(sum);
}

int knn(float inputX[], float inputY[], float inputZ[], int size) {

	int signals = 4;
	int index;
	float distances[signals];
	float minDistance = INFINITY;

	// Normal O
	float window = max(100, size) * DTW_WINDOW_RATIO;
	distances[0] = dtwDistance(inputX, inputY, inputZ, size, normalOx, normalOy, normalOz, 100, window);

	// Fast O
	window = max(35, size) * DTW_WINDOW_RATIO;
	distances[1] = dtwDistance(inputX, inputY, inputZ, size, fastOx, fastOy, fastOz, 35, window);

	// Normal Z
	window = max(91, size) * DTW_WINDOW_RATIO;
	distances[2] = dtwDistance(inputX, inputY, inputZ, size, normalZx, normalZy, normalZz, 91, window);

	// Fast Z
	window = max(34, size) * DTW_WINDOW_RATIO;
	distances[3] = dtwDistance(inputX, inputY, inputZ, size, fastZx, fastZy, fastZz, 34, window);


	// Checking for minor distance
	for(int i = 0; i < signals; i++) {
		if(distances[i] < minDistance) {
			minDistance = distances[i];
			index = i;
		}
	}

	if(minDistance != minDistance) { //Nan
		return minDistance;
	}

	// Negative if the distance is infinity
	return index * (minDistance == INFINITY ? -1 : 1);

}
