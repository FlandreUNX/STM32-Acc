/* Includes */
#include "stm32f4xx.h"
#include "stm32f4_discovery.h"
#include "defines.h"
#include "stm32f4xx.h"
#include "tm_stm32f4_delay.h"
#include "tm_stm32f4_disco.h"
#include <stdio.h>
#include <string.h>
#include "tm_stm32f4_lis302dl_lis3dsh.h"
#include "TestSeries.h"
#include "DTW.h"
#include "LinkedList.h"

// Letter O
double smooth2Ox[140] = {-0.97733333333333328, -0.94813333333333327, -0.93969333333333327, -0.90078533333333322, -0.87954973333333319, -0.86468481333333325, -0.77627936933333319, -0.58839555853333325, -0.46287689097333323, -0.26701382368133325, -0.18990967657693328, -0.12393677360385329, -0.098755741522697296, -0.057129019065888104, -0.024990313346121673, 0.012506780657714829, 0.071754746460400379, 0.05022832252228026, 0.023159825765596182, 0.034211878035917326, 0.035948314625142128, -0.067836179762400514, -0.15848532583368036, -0.18893972808357623, -0.21625780965850333, -0.25638046676095233, -0.24846632673266664, -0.26992642871286665, -0.35394850009900669, -0.54776395006930467, -0.83943476504851322, -1.0376043355339593, -1.2693230348737714, -1.3895261244116399, -1.3746682870881479, -1.3282678009617035, -1.4367874606731923, -1.4977512224712346, -1.4834258557298643, -1.368398099010905, -1.3358786693076334, -1.1601150685153434, -0.94408054796074037, -0.9248563835725182, -1.0823994685007627, -1.0816796279505339, -0.91917573956537368, -0.87742301769576148, -0.81219611238703293, -0.77253727867092303, -0.825776095069646, -0.86604326654875208, -0.80423028658412643, -0.71296120060888846, -0.64007284042622192, -0.5470509882983553, -0.57493569180884863, -0.61845498426619405, -0.59791848898633582, -0.57154294229043501, -0.66408005960330452, -0.73785604172231323, -0.72049922920561915, -0.69634946044393331, -0.52944462231075329, -0.3796112356175273, -0.24472786493226908, -0.096309505452588359, -0.010416653816811852, 0.082708342328231696, 0.018895839629762184, -0.17877291225916647, -0.09814103858141654, 0.090301272993008427, 0.012210891095105897, -0.0064523762334258716, 0.19348333663660189, 0.37543833564562129, 0.38580683495193491, 0.79806478446635443, 1.062645349126448, 1.3018517443885136, 1.3822962210719594, 1.6366073547503714, 1.7966251483252598, 1.7616376038276818, 1.5751463226793772, 1.699602425875564, 1.9517216981128946, 2.149205188679026, 1.942443632075318, 1.7587105424527225, 1.4800973797169055, 1.2550681658018339, 1.0435477160612836, 0.86248340124289846, 0.83473838087002883, 0.86031686660902018, 0.76722180662631412, 0.81905526463841971, 0.8223386852468938, 0.76463707967282568, 0.72724595577097784, 0.66507216903968447, 0.63955051832777909, 0.72368536282944529, 0.70757975398061168, 0.48330582778642811, 0.37131407945049966, 0.46691985561534977, 0.62984389893074488, 0.77689072925152147, 0.83182351047606495, 0.72927645733324542, 0.47449352013327178, 0.2541454640932902, 0.27090182486530312, 0.47463127740571215, 0.39524189418399847, 0.18366932592879889, 0.038568528150159209, -0.12600203029488855, -0.26820142120642199, -0.43974099484449536, -0.6978186963911468, -0.83647308747380267, -0.91253116123166178, -0.89077181286216323, -1.0195402690035142, -1.12167818830246, -1.3041747318117221, -1.4859223122682055, -1.6311456185877438, -1.6848019330114208, -1.7853613531079944, -1.924752947175596, -1.968327063022917, -1.9268289441160418, -1.9037802608812293, -1.8156461826168604};
double smooth2Oy[140] = {-9.602999999999998, -9.5720999999999989, -9.5414700000000003, -9.520029000000001, -9.5290203000000009, -9.5203142100000004, -9.4992199470000003, -9.5744539628999998, -9.6391177740299998, -9.6333824418209986, -9.7133677092746993, -9.814357396492289, -9.8790501775446025, -9.9303351242812212, -9.9902345869968538, -9.9841642108977968, -9.9769149476284582, -9.9988404633399206, -9.9781883243379443, -9.9577318270365609, -9.9104122789255928, -9.9012885952479142, -9.9939020166735393, -10.073731411671478, -10.288611988170034, -10.481028391719024, -10.618719874203316, -10.472103911942321, -10.471472738359624, -10.534030916851737, -10.706821641796216, -10.92077514925735, -10.989542604480144, -10.9896798231361, -11.00477587619527, -11.066343113336687, -10.995440179335681, -10.870808125534976, -10.804565687874483, -10.554195981512137, -10.276937187058497, -10.061856030940946, -9.8332992216586632, -9.7873094551610649, -9.7911166186127456, -9.7877816330289207, -9.6924471431202441, -9.6767130001841704, -9.7166991001289187, -9.7026893700902423, -9.8008825590631687, -9.8216177913442184, -9.8271324539409513, -9.7589927177586659, -9.5942949024310664, -9.4670064317017459, -9.4529045021912221, -9.338033151533855, -9.2096232060736973, -8.9697362442515871, -8.879815370976111, -8.9398707596832772, -8.9279095317782939, -8.9975366722448058, -8.9112756705713636, -8.8598929693999544, -8.8209250785799682, -8.6526475550059772, -8.4418532885041841, -8.3422973019529287, -8.2666081113670504, -8.1446256779569346, -8.1162379745698541, -8.0663665821988975, -8.0524566075392272, -8.204719625277459, -8.3113037376942209, -8.2869126163859548, -8.2098388314701687, -8.2368871820291183, -8.3998210274203817, -8.4208747191942663, -8.3906123034359865, -8.5044286124051904, -8.6651000286836322, -8.7745700200785421, -9.0131990140549796, -9.1892393098384844, -9.186467516886939, -8.9985272618208576, -9.0559690832746007, -9.3181783582922204, -9.6487248508045536, -9.8231073955631878, -9.9481751768942317, -10.125722623825961, -10.331005836678171, -10.42370408567472, -10.374592859972303, -10.283215001980611, -10.294250501386427, -10.178975350970498, -10.155282745679347, -10.216697921975541, -10.241688545382878, -10.085181981768015, -9.9096273872376095, -9.945739171066327, -9.8780174197464277, -9.6926121938224998, -9.4998285356757499, -9.475879974973024, -9.4321159824811165, -9.6594811877367803, -10.067636831415745, -10.362345781991021, -10.325642047393714, -10.0599494331756, -10.03596460322292, -10.055175222256043, -10.050622655579229, -9.9724358589054596, -10.007705101233821, -10.056393570863674, -10.108475499604571, -10.222932849723199, -10.228052994806237, -10.189637096364365, -10.459745967455055, -10.678822177218537, -10.508175524052975, -10.358722866837082, -10.170106006785957, -9.876074204750168, -9.7212519433251181, -9.6968763603275825, -9.7158134522293071, -9.684069416560515, -9.56884859159236, -9.4581940141146514};
double smooth2Oz[140] = {2.4543333333333335, 2.3840333333333334, 2.346823333333333, 2.3177763333333328, 2.435443433333333, 2.5268104033333332, 2.6387672823333332, 2.6541370976333329, 2.7038959683433328, 2.7507271778403326, 2.9065090244882326, 2.9855563171417629, 3.0108894219992339, 2.9536225953994637, 2.892535816779624, 2.9547750717457371, 3.034342550222016, 3.1560397851554112, 3.1872278496087874, 3.0740594947261508, 3.0338416463083053, 2.9426891524158134, 2.9598824066910692, 2.9689176846837482, 2.9332423792786235, 3.1212696654950363, 3.2258887658465252, 3.2991221360925675, 3.3203854952647971, 3.0922698466853582, 2.9655888926797509, 2.8469122248758256, 2.8928385574130777, 3.0449869901891544, 3.1454908931324077, 3.2278436251926852, 3.1174905376348794, 2.8842433763444153, 2.5049703634410907, 2.1944792544087632, 1.9711354780861343, 1.9707948346602939, 2.0335563842622055, 2.0504894689835438, 1.8463426282884805, 1.7664398398019363, 1.8275078878613553, 1.8972555215029487, 1.7570788650520641, 1.5989552055364449, 1.3772686438755113, 1.1290880507128578, 0.79636163549900041, 0.63845314484930016, 0.69891720139451008, 0.72624204097615697, 0.7423694286833098, 0.6666586000783169, 0.63766102005482184, 0.48236271403837522, 0.43965389982686265, 0.30775772987880384, 0.11943041091516268, 0.14360128764061386, 0.031520901348429692, -0.076935369056099226, -0.17385475833926944, -0.14269833083748859, -0.15988883158624201, -0.1599221821103694, -0.10894552747725857, 0.025738130765919021, 0.093016691536143309, 0.083111684075300313, -0.1008218211472898, -0.21457527480310284, -0.18320269236217199, -0.12824188465352038, 0.0092306807425357462, 0.033461476519775019, 0.092423033563842516, 0.046696123494689754, 0.21868728644628282, 0.33608110051239792, 0.27125677035867851, 0.17487973925107497, 0.16441581747575248, 0.27409107223302676, 0.4198637505631187, 0.52490462539418303, 0.36143323777592812, 0.21100326644314968, -0.0082977134897952443, -0.044808399442856667, 0.15763412039000033, 0.54534388427300018, 0.83774071899110014, 1.1474185032937703, 1.3521929523056393, 1.5075350666139475, 1.6672745466297632, 1.671092182640834, 1.8177645278485839, 1.9114351694940086, 1.9770046186458057, 2.0379032330520639, 2.2215322631364445, 2.3980725841955111, 2.4616508089368576, 2.5631555662558001, 2.5352088963790598, 2.6146462274653417, 2.799252359225739, 3.0844766514580169, 3.2301336560206115, 3.2870935592144281, 3.3329654914500995, 3.4940758440150694, 3.7358530908105481, 3.6740971635673834, 3.5918680144971682, 3.4593076101480174, 3.3785153271036119, 3.3969607289725281, 3.4488725102807694, 3.4342107571965386, 3.3549475300375771, 3.4494632710263038, 3.7526242897184128, 3.8028370028028888, 3.8589859019620221, 3.6132901313734154, 3.3093030919613904, 3.1955121643729729, 3.0948585150610808, 2.9374009605427562, 2.8031806723799293, 2.8832264706659503, 3.131258529466165, 3.2898809706263155};

// Letter Z
double smooth2Zx[140] = {-0.26316666666666666, -0.12121666666666664, -0.15685166666666664, -0.2537961666666666, -0.25565731666666663, -0.3889601216666666, -0.49427208516666665, -0.60999045961666665, -0.8019933217316666, -1.0383953252121665, -1.2338767276485165, -1.3617137093539615, -1.478199596547773, -1.5417397175834409, -1.6012178023084085, -1.5588524616158859, -1.56219672313112, -1.4805377061917839, -1.3003763943342488, -1.1562634760339741, -1.0553844332237818, -0.90076910325664727, -0.75953837227965304, -0.68167686059575716, -0.64817380241703004, -0.73572166169192099, -0.74900516318434462, -0.67730361422904128, -0.65711252996032887, -0.74797877097223009, -0.73358513968056105, -0.56150959777639275, -0.34805671844347491, -0.2316397029104324, -0.14714779203730266, -0.067003454426111858, -0.010902418098278299, 0.022368307331205189, 0.29765781513184358, 0.82336047059229034, 1.3623523294146032, 1.8446466305902223, 2.2152526414131555, 2.5556768489892088, 2.9049737942924461, 3.194481656004712, 3.2681371592032984, 3.1696960114423089, 3.0227872080096159, 2.7969510456067308, 2.5698657319247116, 2.2369060123472981, 2.0458342086431083, 1.8520839460501757, 1.7224587622351228, 1.7817211335645857, 1.89220479349521, 1.8825433554466469, 1.6837803488126526, 1.3796462441688568, 1.1607523709181997, 1.1935266596427399, 1.1954686617499179, 1.0738280632249424, 0.8896796442574596, 0.73677575098022163, 0.61774302568615513, 0.49242011798030855, 0.33569408258621597, 0.12698585781035115, 0.1548901004672458, 0.17442307032707205, -0.066903850771049572, -0.24483269553973469, -0.41738288687781422, -0.51416802081446988, -0.42891761457012889, -0.50124233019909026, -0.74986963113936311, -0.78590874179755421, -0.65813611925828785, -0.50869528348080151, -0.64708669843656108, -0.8099606889055927, -0.7679724822339149, -0.68158073756374038, -0.76510651629461823, -0.98257456140623267, -1.4138021929843627, -2.0186615350890538, -2.4210630745623378, -2.4597441521936361, -2.4568209065355453, -2.4757746345748819, -2.4410422442024169, -2.3747295709416916, -2.1243106996591843, -1.9580174897614291, -1.7636122428330003, -1.6275285699831001, -1.61926999898817, -1.7004889992917189, -1.8743422995042032, -2.2000396096529422, -2.4700277267570594, -2.6650194087299415, -2.7925135861109589, -2.917759510277671, -2.9724316571943694, -2.8607021600360589, -2.7134915120252412, -2.5024440584176686, -2.306710840892368, -2.1876975886246575, -1.9453883120372601, -1.6377718184260821, -1.4374402728982574, -1.2822081910287801, -1.0775457337201459, -1.0152820136041021, -0.89069740952287146, -0.62348818666601002, -0.26544173066620702, 0.19219078853365509, 0.5875335519735585, 0.90327348638149085, 1.2742914404670436, 1.4500040083269305, 1.5790028058288512, 1.6183019640801959, 1.366811374856137, 1.0497679623992959, 0.63883757367950711, 0.32418630157565492, 0.037930411102958417, -0.045448712227929108, -0.17881409855955038, -0.33216986899168521, -0.44251890829417961, -0.50776323580592564};
double smooth2Zy[140] = {-9.8778333333333332, -9.911483333333333, -9.9920383333333334, -9.9674268333333327, -9.9291987833333337, -9.8424391483333338, -9.760707403833333, -9.7274951826833327, -9.7732466278783328, -9.7842726395148318, -9.9089908476603803, -9.8672935933622661, -9.8591055153535869, -9.9493738607475102, -10.009561702523257, -9.9496931917662792, -9.8927852342363956, -9.9189496639654759, -9.8742647647758321, -9.7949853353430818, -9.7514897347401561, -9.7270428143181089, -9.7699299700226749, -9.7939509790158716, -9.7477656853111103, -9.6644359797177763, -9.5191051858024434, -9.5613736300617109, -9.9119615410431976, -10.112373078730238, -10.111661155111166, -10.099162808577816, -10.090413966004471, -10.090289776203129, -10.105202843342189, -10.043641990339532, -10.003549393237673, -9.8944845752663699, -9.7761392026864584, -9.8942974418805196, -9.9710082093163628, -9.8777057465214533, -9.9083940225650178, -9.860875815795513, -9.7286130710568592, -9.4290291497398009, -9.2403204048178598, -9.0842242833725013, -8.8879569983607496, -8.8585698988525241, -8.8349989291967663, -8.8544992504377369, -8.8711494753064155, -8.8288046327144905, -8.7871632429001423, -8.6680142700300991, -8.6146099890210692, -8.5892269923147477, -8.7784588946203232, -9.1449212262342261, -9.3504448583639572, -9.3293114008547704, -9.2725179805983391, -9.2927625864188368, -9.4029338104931863, -9.4830536673452297, -9.5211375671416594, -9.5837962969991608, -9.6606574078994125, -9.7774601855295877, -9.6492221298707115, -9.5744554909094983, -9.5581188436366489, -9.648683190545654, -9.7660782333819576, -9.8362547633673696, -9.7743783343571593, -9.7790648340500113, -9.9443453838350067, -9.8290417686845046, -9.6253292380791535, -9.5277304666554059, -9.8134113266587839, -10.073387928661148, -10.102371550062802, -9.7806600850439604, -9.7324620595307714, -9.9807234416715396, -10.358506409170078, -10.781954486419053, -11.252368140493337, -11.443657698345335, -11.451560388841735, -11.409092272189215, -11.35836459053245, -11.181855213372714, -10.929298649360899, -10.668509054552629, -10.374956338186839, -10.016469436730787, -9.7865286057115508, -9.5805700239980851, -9.3613990167986589, -9.1989793117590608, -9.106285518231342, -9.0803998627619382, -9.0592799039333567, -9.1164959327533488, -9.0635471529273435, -8.9334830070491407, -9.1724381049343986, -9.4477066734540784, -9.5983946714178536, -9.637876269992498, -9.5335133889947485, -9.4484593722963233, -9.5479215606074259, -9.7645450924251982, -9.9851815646976387, -10.121627095288346, -10.058138966701842, -9.9146972766912889, -9.673288093683901, -9.51030166557873, -9.4382111659051091, -9.5047478161335768, -9.6023234712935022, -9.7066264299054517, -9.7676385009338169, -9.8163469506536707, -9.970442865457569, -10.087310005820298, -10.091117004074208, -10.003781902851944, -9.9156473319963609, -9.7579531323974535, -9.5965671926782168, -9.4595970348747507, -9.4207179244123243, -9.4175025470886258};
double smooth2Zz[140] = {0.35666666666666658, 0.4506666666666666, 0.39946666666666664, 0.41762666666666665, 0.47833866666666663, 0.53583706666666664, 0.4890859466666666, 0.39036016266666657, 0.32125211386666658, 0.24887647970666657, 0.2522135357946666, 0.23954947505626661, 0.14668463253938663, 0.036679242777570634, 0.046675469944299441, 0.13467282896100963, 0.15727098027270675, 0.15808968619089472, 0.1136627803336263, 0.11556394623353841, 0.23089476236347689, 0.29962633365443381, 0.31173843355810366, 0.22721690349067256, 0.18305183244347079, 0.31713628271042954, 0.45599539789730065, 0.46319677852811048, 0.39023774496967734, 0.42916642147877415, 0.48341649503514189, 0.55739154652459932, 0.58817408256721948, 0.57372185779705365, 0.59660530045793747, 0.62162371032055619, 0.53413659722438933, 0.48189561805707248, 0.46632693263995073, 0.44342885284796546, 0.54740019699357578, 0.65318013789550311, 0.81422609652685218, 0.94195826756879653, 1.0523707872981576, 1.1716595511087102, 1.2311616857760972, 1.305813180043268, 1.3100692260302875, 1.3340484582212011, 1.2038339207548407, 0.99568374452838848, 0.79897862116987184, 0.63128503481891018, 0.66989952437323708, 0.73292966706126594, 0.79205076694288612, 0.88743553686002019, 1.0532048758020141, 1.1932434130614098, 1.3572703891429869, 1.3940892724000908, 1.2878624906800635, 1.1445037434760446, 0.84315262043323114, 0.75220683430326174, 0.69754478401228326, 0.65328134880859823, 0.79929694416601871, 0.99750786091621313, 1.1692555026413491, 1.2174788518489443, 1.158235196294261, 1.2037646374059827, 1.1996352461841879, 1.2357446723289316, 1.4410212706302521, 1.5577148894411765, 1.6244004226088236, 1.5450802958261765, 1.5435562070783233, 1.7164893449548262, 1.9275425414683782, 2.2192797790278647, 2.4024958453195051, 2.5217470917236535, 2.5242229642065572, 2.4299560749445899, 2.3009692524612126, 2.1266784767228488, 1.9266749337059941, 1.849672453594196, 1.9697707175159369, 2.1318395022611556, 2.2482876515828085, 2.3718013561079658, 2.4612609492755757, 2.5328826644929032, 2.7090178651450323, 2.7273125056015224, 2.7581187539210656, 2.7346831277447459, 2.6102781894213218, 2.316194732594925, 1.8853363128164475, 1.4937354189715131, 1.315614793280059, 1.4369303552960413, 1.7228512487072289, 1.9469958740950601, 1.8938971118665422, 1.8597279783065794, 2.0248095848146055, 2.3863667093702237, 2.5224566965591566, 2.5667196875914096, 2.5287037813139865, 2.6610926469197906, 2.7897648528438532, 3.0508353969906974, 3.2545847778934878, 3.2742093445254414, 3.2009465411678089, 3.191662578817466, 3.0891638051722259, 3.1284146636205579, 3.1888902645343906, 3.4142231851740732, 3.7189562296218508, 3.9922693607352953, 4.0695885525147064, 4.0127119867602943, 3.8288983907322058, 3.5412288735125443, 3.2588602114587806, 2.9652021480211461, 2.9006415036148026, 2.8944490525303617, 2.9261143367712528, 2.90628003573987};

void setup() {
	SystemInit();
	TM_DELAY_Init();
	TM_DISCO_LedInit();
	TM_LIS302DL_LIS3DSH_Init(TM_LIS3DSH_Sensitivity_2G, TM_LIS3DSH_Filter_50Hz);
	TM_DISCO_ButtonInit();
}

int main(void) {

	setup();

	int count = 0;

	// Raw signals
	LinkedList *signalX = newLinkedList();
	LinkedList *signalY = newLinkedList();
	LinkedList *signalZ = newLinkedList();

	TM_LIS302DL_LIS3DSH_t Axes_Data;

	// Waiting for blue button to start sampling
	while(!TM_DISCO_ButtonPressed());

	TM_DISCO_LedOn(LED_RED | LED_GREEN);

	while(TM_DISCO_ButtonPressed()) {

		// Adding accelerometer values
		TM_LIS302DL_LIS3DSH_ReadAxes(&Axes_Data);
		prependToLinkedList(signalX, (double) Axes_Data.X / ACCELEROMETER_DATA_DIVIDER);
		prependToLinkedList(signalY, (double) Axes_Data.Y / ACCELEROMETER_DATA_DIVIDER);
		prependToLinkedList(signalZ, (double) Axes_Data.Z / ACCELEROMETER_DATA_DIVIDER);
		count++;

		Delayms(SAMPLEPERIOD);

	}

	TM_DISCO_LedOff(LED_RED | LED_GREEN);

	// Allocating the temporary arrays to store the raw signal
	double *tempX = (double *) malloc(count * sizeof(double));
	double *tempY = (double *) malloc(count * sizeof(double));
	double *tempZ = (double *) malloc(count * sizeof(double));

	// Filling up the temporary raw signal arrays
	arrayFromLinkedList(signalX, tempX, count);
	arrayFromLinkedList(signalY, tempY, count);
	arrayFromLinkedList(signalZ, tempZ, count);

	// Freeing the memory for the linked lists
	freeLinkedList(signalX);
	freeLinkedList(signalY);
	freeLinkedList(signalZ);

	// Allocating arrays for the smoothed signals
	double smoothX[200];
	double smoothY[200];
	double smoothZ[200];
	int i = 0;
	for(i = 0; i < 200; i++) {
		smoothX[i] = 666.666;
		smoothY[i] = 666.666;
		smoothZ[i] = 666.666;
	}

	// Calculating the smoothed values
	ewma(tempX, count, smoothX);
	ewma(tempY, count, smoothY);
	ewma(tempZ, count, smoothZ);

	double o = dtwDistance(smoothX, smoothY, smoothZ, count, smooth2Ox, smooth2Oy, smooth2Oz, 140);
	double z = dtwDistance(smoothX, smoothY, smoothZ, count, smooth2Zx, smooth2Zy, smooth2Zz, 140);

	o += 1;

	while(1);

}



/*
 * Callback used by stm32f4_discovery_audio_codec.c.
 * Refer to stm32f4_discovery_audio_codec.h for more info.
 */
void EVAL_AUDIO_TransferComplete_CallBack(uint32_t pBuffer, uint32_t Size){
	/* TODO, implement your code here */
	return;
}

/*
 * Callback used by stm324xg_eval_audio_codec.c.
 * Refer to stm324xg_eval_audio_codec.h for more info.
 */
uint16_t EVAL_AUDIO_GetSampleCallBack(void){
	/* TODO, implement your code here */
	return -1;
}
